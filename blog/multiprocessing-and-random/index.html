<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Multiprocessing and &lt;code>random()&lt;/code> - 152334H</title><meta name=Description content="152334H Personal Blog"><meta property="og:title" content="Multiprocessing and <code>random()</code>"><meta property="og:description" content="Let&rsquo;s say, for some odd reason, you&rsquo;re hosting a Python service that:

takes requests that run large computations based on a randomly generated number (a &ldquo;seed&rdquo;)
spreads work across multiple workers to handle many requests

Then, it&rsquo;s likely you&rsquo;ll introduce a subtle randomness bug that leads to duplicate seeds appearing. Let me explain:"><meta property="og:type" content="article"><meta property="og:url" content="https://152334H.github.io/blog/multiprocessing-and-random/"><meta property="og:image" content="https://152334H.github.io/undefined.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-02T00:00:00+08:00"><meta property="article:modified_time" content="2022-09-28T09:34:03+01:00"><meta property="og:site_name" content="152334H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://152334H.github.io/undefined.png"><meta name=twitter:title content="Multiprocessing and <code>random()</code>"><meta name=twitter:description content="Let&rsquo;s say, for some odd reason, you&rsquo;re hosting a Python service that:

takes requests that run large computations based on a randomly generated number (a &ldquo;seed&rdquo;)
spreads work across multiple workers to handle many requests

Then, it&rsquo;s likely you&rsquo;ll introduce a subtle randomness bug that leads to duplicate seeds appearing. Let me explain:"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://152334H.github.io/blog/multiprocessing-and-random/><link rel=prev href=https://152334H.github.io/blog/dn-2/><link rel=next href=https://152334H.github.io/blog/end-of-hiatus/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Multiprocessing and \u003ccode\u003erandom()\u003c/code\u003e","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/152334H.github.io\/blog\/multiprocessing-and-random\/"},"genre":"posts","keywords":"code, python","wordcount":1552,"url":"https:\/\/152334H.github.io\/blog\/multiprocessing-and-random\/","datePublished":"2022-10-02T00:00:00+08:00","dateModified":"2022-09-28T09:34:03+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"152334H"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=152334H>Simple Thoughts</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>All Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/><b>About </b></a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=152334H>Simple Thoughts</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>All Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title><b>About</b></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Multiprocessing and <code>random()</code></h1><h2 class=single-subtitle><code>srand()</code> but cooler</h2><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://152334H.github.io/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>152334H</a></span>&nbsp;<span class=post-category>included in <a href=/categories/tech/><i class="far fa-folder fa-fw" aria-hidden=true></i>tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime="October 2, 2022">October 2, 2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1552 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#randomness-single-process-single-threaded>Randomness: single-process single-threaded</a></li><li><a href=#multiprocessing-and-fork>Multiprocessing and <code>fork()</code></a></li><li><a href=#speculation>Speculation</a><ul><li><a href=#the-forkmethod-is-important>The <code>forkmethod</code> is important</a></li><li><a href=#random-state-is-copied-but-overwritten><code>random</code> state is copied, but overwritten</a></li></ul></li><li><a href=#in-conclusion>In conclusion</a></li></ul></nav></div></div><div class=content id=content><p>Let&rsquo;s say, for <a href=https://huggingface.co/blog/stable_diffusion target=_blank rel="noopener noreffer">some odd reason</a>, you&rsquo;re hosting a Python service that:</p><ol><li>takes requests that run large computations based on a randomly generated number (a &ldquo;seed&rdquo;)</li><li>spreads work across multiple workers to handle many requests</li></ol><p>Then, it&rsquo;s likely you&rsquo;ll introduce a subtle randomness bug that leads to duplicate seeds appearing. Let me explain:</p><div class="details admonition info"><div class="details-summary admonition-title"><i class="icon fas fa-info-circle fa-fw" aria-hidden=true></i>Regarding Reproducibility<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>The following tests were done on a Ubuntu 20.04 LTS Hetzner instance using:</p><ol><li><code>numpy==1.22.4</code></li><li><code>python==3.8.10</code></li></ol><p>I additionally made efforts to test certain outcomes on Ubuntu 18 LTS with Python 3.6.9, albeit with much uglier logging due to the lack of f-string improvements.</p></div></div></div><h2 id=randomness-single-process-single-threaded>Randomness: single-process single-threaded</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ python3 -c <span class=s1>&#39;print(__import__(&#34;random&#34;).random())&#39;</span>
</span></span><span class=line><span class=cl>0.7457432716191408
</span></span><span class=line><span class=cl>$ python3 -c <span class=s1>&#39;print(__import__(&#34;random&#34;).random())&#39;</span>
</span></span><span class=line><span class=cl>0.9558957103766177
</span></span><span class=line><span class=cl>$ <span class=c1># applies for numpy.random too!</span>
</span></span><span class=line><span class=cl>$ python3 -c <span class=s1>&#39;print(__import__(&#34;numpy&#34;).random.randint(9999))&#39;</span>
</span></span><span class=line><span class=cl><span class=m>5388</span>
</span></span><span class=line><span class=cl>$ python3 -c <span class=s1>&#39;print(__import__(&#34;numpy&#34;).random.randint(9999))&#39;</span>
</span></span><span class=line><span class=cl><span class=m>236</span>
</span></span></code></pre></td></tr></table></div></div><p>Typically, there&rsquo;s no need to fiddle with the internal configuration of Python&rsquo;s <code>random</code> module. Python seeds its Mersenne Twister thing with <a href=https://docs.python.org/3/library/random.html#random.seed target=_blank rel="noopener noreffer">os.urandom by default</a>, and even if you&rsquo;re on some really obscure operating system, it seeds <a href=https://github.com/python/cpython/blob/main/Modules/_randommodule.c#L290 target=_blank rel="noopener noreffer">by time</a> which is pretty hard to collide with milisecond accuracy:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=c1># Test: Spawning 5 processes quickly by backgrounding (&amp;) them</span>
</span></span><span class=line><span class=cl>$ <span class=k>for</span> i in <span class=sb>`</span>seq <span class=m>1</span> 5<span class=sb>`</span>
</span></span><span class=line><span class=cl>&gt; <span class=k>do</span> python3 -c <span class=s1>&#39;print(__import__(&#34;random&#34;).random())&#39;</span> <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>&gt; <span class=k>done</span>
</span></span><span class=line><span class=cl>0.4576075693594288
</span></span><span class=line><span class=cl>0.7804091843861601
</span></span><span class=line><span class=cl>0.9347442769592177
</span></span><span class=line><span class=cl>0.9520767305433322
</span></span><span class=line><span class=cl>0.12542097628111482
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s not to say that this is <em>cryptographically secure</em> or anything, but for the purposes laid out in the introduction, it&rsquo;s more than sufficiently random for our purposes.</p><p>But, as with all things Python, things get a bit dicer as we scale.</p><h2 id=multiprocessing-and-fork>Multiprocessing and <code>fork()</code></h2><p>As explained on the <a href=https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods target=_blank rel="noopener noreffer"><code>multiprocessing</code> docpage</a>, the default methodology for spawning multiple Python processes on Linux is to abuse <code>os.fork()</code>.</p><p>The <a href=https://www.man7.org/linux/man-pages/man2/fork.2.html target=_blank rel="noopener noreffer">fork syscall</a>, for those who don&rsquo;t know, is approximately &ldquo;an OS function that creates a bit-for-bit copy of an existing process&rdquo;, with exceptions listed in the preceding link. The random state of a PRNG <em>should</em> be stored somewhere in process memory, so it stands to reason that <strong>multiple Python processes <code>fork()</code>ed from the same parent will have the same seed</strong>.</p><p>We can test this theory with a simple script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>multiprocessing</span> <span class=k>as</span> <span class=nn>mp</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span> <span class=k>as</span> <span class=nn>r</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>_</span><span class=p>):</span> <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000</span><span class=p>),</span> <span class=n>r</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>999</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>mp</span><span class=o>.</span><span class=n>Pool</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,(</span><span class=n>np_v</span><span class=p>,</span><span class=n>py_v</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>))):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>i</span> <span class=o>&amp;</span> <span class=mb>0b11</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;-&#39;</span><span class=o>*</span><span class=mi>23</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>i</span><span class=si>:</span><span class=s1>2</span><span class=si>}</span><span class=s1>: </span><span class=si>{</span><span class=n>np_v</span><span class=si>=:</span><span class=s1>3</span><span class=si>}</span><span class=s1> | </span><span class=si>{</span><span class=n>py_v</span><span class=si>=:</span><span class=s1>3</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>TLDR: Run <code>np.random.randint</code> and <code>random.randint</code> with 4 python processes in parallel; print dividing line every 4 outputs.</p><p>The results from this script are fairly surprising:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>$</span> <span class=n>python3</span> <span class=n>rand_test</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl> <span class=mi>0</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>711</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>969</span>
</span></span><span class=line><span class=cl> <span class=mi>1</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>893</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>988</span>
</span></span><span class=line><span class=cl> <span class=mi>2</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>650</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>588</span>
</span></span><span class=line><span class=cl> <span class=mi>3</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>539</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>213</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl> <span class=mi>4</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>711</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>413</span>
</span></span><span class=line><span class=cl> <span class=mi>5</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>893</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>192</span>
</span></span><span class=line><span class=cl> <span class=mi>6</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>650</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span> <span class=mi>72</span>
</span></span><span class=line><span class=cl> <span class=mi>7</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>539</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>895</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl> <span class=mi>8</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>711</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>625</span>
</span></span><span class=line><span class=cl> <span class=mi>9</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>893</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>133</span>
</span></span><span class=line><span class=cl><span class=mi>10</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>650</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>261</span>
</span></span><span class=line><span class=cl><span class=mi>11</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>539</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>401</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl><span class=mi>12</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>711</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>805</span>
</span></span><span class=line><span class=cl><span class=mi>13</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>893</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>995</span>
</span></span><span class=line><span class=cl><span class=mi>14</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>650</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>295</span>
</span></span><span class=line><span class=cl><span class=mi>15</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>539</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>429</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl><span class=mi>16</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>237</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>221</span>
</span></span><span class=line><span class=cl><span class=mi>17</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>769</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>661</span>
</span></span><span class=line><span class=cl><span class=mi>18</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>136</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>248</span>
</span></span><span class=line><span class=cl><span class=mi>19</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>967</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>505</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl><span class=mi>20</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>237</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>759</span>
</span></span><span class=line><span class=cl><span class=mi>21</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>769</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>659</span>
</span></span><span class=line><span class=cl><span class=mi>22</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>136</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>587</span>
</span></span><span class=line><span class=cl><span class=mi>23</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>967</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>562</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl><span class=mi>24</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>237</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>922</span>
</span></span><span class=line><span class=cl><span class=mi>25</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>769</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>365</span>
</span></span><span class=line><span class=cl><span class=mi>26</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>136</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>441</span>
</span></span><span class=line><span class=cl><span class=mi>27</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>967</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>755</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl><span class=mi>28</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>802</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>778</span>
</span></span><span class=line><span class=cl><span class=mi>29</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>744</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>886</span>
</span></span><span class=line><span class=cl><span class=mi>30</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>359</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>112</span>
</span></span><span class=line><span class=cl><span class=mi>31</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>349</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>839</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span><span class=line><span class=cl><span class=mi>32</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>237</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>301</span>
</span></span><span class=line><span class=cl><span class=mi>33</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>769</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>483</span>
</span></span><span class=line><span class=cl><span class=mi>34</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>136</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>465</span>
</span></span><span class=line><span class=cl><span class=mi>35</span><span class=p>:</span> <span class=n>np_v</span><span class=o>=</span><span class=mi>967</span> <span class=o>|</span> <span class=n>py_v</span><span class=o>=</span><span class=mi>937</span>
</span></span><span class=line><span class=cl><span class=o>-----------------------</span>
</span></span></code></pre></td></tr></table></div></div><p>If you will observe: The <code>numpy.random</code> outputs <strong>repeat 4 times</strong> (every 4 steps), while the randomness of vanilla <code>random</code> is secure across processes. So we can infer that:</p><ol><li><code>numpy.random</code>&rsquo;s PRNG state is captured (pickled) by the multiprocessing library and copied identically across 4 workers;</li><li><code>random</code>&rsquo;s PRNG state is <strong>not</strong> duplicated. It could either be shared across all workers, or reseeded within each worker on startup.</li></ol><p>To figure out the answer to (2), we can just modify the script to print out the initial state of the PRNGs on worker start:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>yes</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>	<span class=k>global</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=n>yes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=n>s</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>get_state</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=n>np_state</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>((</span><span class=o>*</span><span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=o>*</span><span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>		<span class=n>py_state</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>getstate</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>np_state</span><span class=si>=:</span><span class=s1>20</span><span class=si>}</span><span class=s1>, </span><span class=si>{</span><span class=n>py_state</span><span class=si>=:</span><span class=s1>20</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>yes</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>	<span class=c1># ...</span>
</span></span></code></pre></td></tr></table></div></div><p>As expected, the <code>numpy.random</code> initial state is equivalent across all workers. Unexpectedly, the <code>random</code> initial states do not, and they remain different even when I extend the sleep duration to infinity, indicating a new <code>random._inst</code> state is initialised per worker:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>$</span> <span class=n>python3</span> <span class=n>scratch</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=n>np_state</span><span class=o>=</span> <span class=mi>8542083115030040073</span><span class=p>,</span> <span class=n>py_state</span><span class=o>=</span> <span class=o>-</span><span class=mi>509295089981894936</span>
</span></span><span class=line><span class=cl><span class=n>np_state</span><span class=o>=</span> <span class=mi>8542083115030040073</span><span class=p>,</span> <span class=n>py_state</span><span class=o>=</span> <span class=mi>7542824820053631765</span>
</span></span><span class=line><span class=cl><span class=n>np_state</span><span class=o>=</span> <span class=mi>8542083115030040073</span><span class=p>,</span> <span class=n>py_state</span><span class=o>=-</span><span class=mi>7860580465393152951</span>
</span></span><span class=line><span class=cl><span class=n>np_state</span><span class=o>=</span> <span class=mi>8542083115030040073</span><span class=p>,</span> <span class=n>py_state</span><span class=o>=-</span><span class=mi>9195119932724983682</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>At this point I&rsquo;m pretty confused. The <code>numpy</code> module was getting pickled, but the <code>random</code> module was not. Could I force a pickling of the <code>random</code> state?</p><p>I tried extending the test script to cover more things:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span> <span class=k>as</span> <span class=nn>t</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span> <span class=k>as</span> <span class=nn>r</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>multiprocessing</span> <span class=k>as</span> <span class=nn>mp</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>r_pickled</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>get_state</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>np_rand_hash</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>(</span><span class=nb>tuple</span><span class=p>((</span><span class=o>*</span><span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>*</span><span class=n>s</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=mi>5</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>    <span class=n>py_rand_hash</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>getstate</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>pi_rand_hash</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>(</span><span class=n>r_pickled</span><span class=o>.</span><span class=n>getstate</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;np_s&#39;</span><span class=p>:</span> <span class=n>np_rand_hash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;py_s&#39;</span><span class=p>:</span> <span class=n>py_rand_hash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;pi_s&#39;</span><span class=p>:</span> <span class=n>pi_rand_hash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># all of these generate in range(10000):</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;np_v&#39;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>100000</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;py_v&#39;</span><span class=p>:</span> <span class=n>r</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>99999</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;pi_v&#39;</span><span class=p>:</span> <span class=n>r_pickled</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>99999</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ITERS</span> <span class=o>=</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>NUM_WORKERS</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>mp</span><span class=o>.</span><span class=n>Pool</span><span class=p>(</span><span class=n>NUM_WORKERS</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>_inst</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>ITERS</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Unique numpy.random states:&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;np_s&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>res</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Unique np.random.randint():&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;np_v&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>res</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Unique random states:&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;py_s&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>res</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Unique random.randint():&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;py_v&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>res</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Unique r._inst states:&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;pi_s&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>res</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Unique r._inst.randint():&#39;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=s1>&#39;pi_v&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>res</span><span class=p>)))</span>
</span></span></code></pre></td></tr></table></div></div><p>In short, I&rsquo;m asking (over 128 iterations): how many unique PRNG states / random numbers are there across all processes?</p><p>And the answer is weird:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=err>$</span> <span class=n>python3</span> <span class=n>t</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=n>Unique</span> <span class=n>numpy</span><span class=o>.</span><span class=n>random</span> <span class=n>states</span><span class=p>:</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=n>Unique</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>():</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=n>Unique</span> <span class=n>random</span> <span class=n>states</span><span class=p>:</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>Unique</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>():</span> <span class=mi>128</span>
</span></span><span class=line><span class=cl><span class=n>Unique</span> <span class=n>r</span><span class=o>.</span><span class=n>_inst</span> <span class=n>states</span><span class=p>:</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=n>Unique</span> <span class=n>r</span><span class=o>.</span><span class=n>_inst</span><span class=o>.</span><span class=n>randint</span><span class=p>():</span> <span class=mi>8</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>if you use <code>numpy.random</code>, you get <code>ITERS/NUM_WORKERS</code> unique outcomes, (or <code>NUM_WORKERS</code> collisions of the same seed)</li><li>if you use <code>random</code>, the module, you get <code>ITERS</code> unique outcomes (regardless of number of processes)</li><li>if you <em>use the parent process&rsquo;s <code>random.Random</code> instance</em>, stored at <code>random._inst</code>, as an argument to a multiworker task, the <code>random.Random</code> instance will get pickled, and the number of unique outcomes will be <code>ITERS/NUM_WORKERS/4</code>. This formula scales well with both varying <code>ITERS</code> and <code>NUM_WORKERS</code>.</li></ol><p>So at this point, I&rsquo;m doubly confused. I haven&rsquo;t figured out why <code>random</code> succeeds in re-initing state in new processes, and I now have a new question of what mechanism keeps the pickled <code>random._inst</code> PRNG state ticking forwards.</p><h2 id=speculation>Speculation</h2><p>And so, I move into the fog of unverified ideas and poorly substantiated hypotheses.</p><hr><h3 id=the-forkmethod-is-important>The <code>forkmethod</code> is important</h3><p>I tried switching up the forkmethod from <code>fork</code> to <code>forkserver</code>/<code>spawn</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=k>with</span> <span class=n>mp</span><span class=o>.</span><span class=n>get_context</span><span class=p>(</span><span class=s2>&#34;forkserver&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>Pool</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span> <span class=k>as</span> <span class=n>p</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=n>i</span><span class=p>,(</span><span class=n>np_v</span><span class=p>,</span><span class=n>py_v</span><span class=p>,</span><span class=n>h_delta</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=nb>range</span><span class=p>(</span><span class=mi>50</span><span class=p>))):</span>
</span></span><span class=line><span class=cl>		<span class=k>pass</span>
</span></span></code></pre></td></tr></table></div></div><p>In both cases, the random states of both <code>numpy</code> and <code>random</code> became different in all workers:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ python3 scratch.py
</span></span><span class=line><span class=cl><span class=nv>np_state</span><span class=o>=</span> -664522000653194140, <span class=nv>py_state</span><span class=o>=</span> <span class=m>7612061459549224940</span>
</span></span><span class=line><span class=cl><span class=nv>np_state</span><span class=o>=</span> 4019719269418835448, <span class=nv>py_state</span><span class=o>=</span> -826723981683651496
</span></span><span class=line><span class=cl><span class=nv>np_state</span><span class=o>=</span>-3004816782852048973, <span class=nv>py_state</span><span class=o>=</span>-3881656698949473802
</span></span><span class=line><span class=cl><span class=nv>np_state</span><span class=o>=</span>  374882113652371457, <span class=nv>py_state</span><span class=o>=</span>  <span class=m>746934503431840062</span>
</span></span></code></pre></td></tr></table></div></div><p>Only the choice of <code>fork</code> causes the initial seeds of numpy to differ. Why? I&rsquo;m not sure; you can start with <a href=https://github.com/python/cpython/tree/3.10/Lib/multiprocessing/ target=_blank rel="noopener noreffer">the source code here</a>, but it&rsquo;s not simple.</p><h3 id=random-state-is-copied-but-overwritten><code>random</code> state is copied, but overwritten</h3><p>The <code>pickle</code> representation of both <code>numpy.random.randint</code> and <code>random.randint</code> are both large <em>and</em> similar in size:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>pickle</span> <span class=k>as</span> <span class=nn>p</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>random</span> <span class=k>as</span> <span class=nn>r</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>randint</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>3804</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>2825</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=k>def</span> <span class=nf>f</span><span class=p>():</span> <span class=k>pass</span>   <span class=c1># empty func</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>f</span><span class=p>))</span> <span class=c1># as comparison</span>
</span></span><span class=line><span class=cl><span class=mi>29</span>
</span></span></code></pre></td></tr></table></div></div><p>Plugging the outputs of <strong>either</strong> <code>randint()</code> function into <code>pickletools.dis()</code> shows a large stored array of numbers, which I assume is representative of their PRNG states. If the multiprocessing library <em>does</em> capture the state of <code>random</code> before execution, then something about the initialisation process of each worker must recreate the <code>random</code> state again.</p><p>Alternatively, the <code>random.randint()</code> function is not captured by the <code>multiprocessing</code> module entirely. But I find this difficult to believe, because it has to capture <em>something</em> to run the <code>randint</code> function, and since <code>pickle</code> is unable to dump <code>module</code> types, I&rsquo;m unable to come up with another idea here.</p><p>This also explains why explicitly capturing <code>r._inst</code> succeeds in creating duplicate seeds &ndash; the <code>multiprocessing</code> library reinitiallises <code>random._inst</code>, but the function-provided <code>r_inst</code> object remains as a separate instance.</p><hr><h2 id=in-conclusion>In conclusion</h2><ol><li>Using <code>random.*</code> explicitly in a multiprocessed function will never go wrong. Speculation: the multiprocessing library recreates a <code>random.Random</code> object per worker.</li><li>Using <code>numpy.random</code> with multiprocessing using <code>fork</code> will cause predictable random number duplication. The PRNG state is captured by <code>pickle</code> and copied between processes.</li><li>Using <em>a copy of <code>random._inst</code></em> as an <em>argument</em> for a multiprocessed task will cause even more duplication than the <code>numpy</code> option. Mechanism unknown.</li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on September 28, 2022&nbsp;<a class=git-hash href=https://github.com/152334H/blog/commit/83ffad2e2e0acdf5350a7c97a62008727efa4f81 target=_blank title="commit by 152334H(54623771+152334H@users.noreply.github.com) 83ffad2e2e0acdf5350a7c97a62008727efa4f81: Post: Multiprocessing and random()">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>83ffad2</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://152334H.github.io/blog/multiprocessing-and-random/ data-title="Multiprocessing and <code>random()</code>" data-hashtags=code,python><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://152334H.github.io/blog/multiprocessing-and-random/ data-hashtag=code><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://152334H.github.io/blog/multiprocessing-and-random/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://152334H.github.io/blog/multiprocessing-and-random/ data-title="Multiprocessing and <code>random()</code>"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://152334H.github.io/blog/multiprocessing-and-random/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://152334H.github.io/blog/multiprocessing-and-random/ data-title="Multiprocessing and <code>random()</code>"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://152334H.github.io/blog/multiprocessing-and-random/ data-title="Multiprocessing and <code>random()</code>"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/code/>code</a>,&nbsp;<a href=/tags/python/>python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/blog/dn-2/ class=prev rel=prev title="Disco Narrator - Data Formatting"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Disco Narrator - Data Formatting</a>
<a href=/blog/end-of-hiatus/ class=next rel=next title="Recent ML Projects">Recent ML Projects<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://152334H.github.io/ target=_blank>152334H</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOH03r284CQ2Tu",darkTheme:"dark_dimmed",emitMetadata:"0",inputPosition:"bottom",lang:"en",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"152334H/152334h.github.io",repoId:"R_kgDOH03r2w"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W0STJ4D3N3",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-W0STJ4D3N3" async></script></body></html>